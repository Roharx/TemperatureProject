Œ	
)C:\tempProjNew\api\Config\MqttSettings.cs
	namespace 	
api
 
. 
Config 
{ 
public 

class 
MqttSettings 
{ 
public 
string 
	BrokerUrl 
{  !
get" %
;% &
set' *
;* +
}, -
public 
int 
Port 
{ 
get 
; 
set "
;" #
}$ %
public 
string 
ClientId 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 
Username 
{  
get! $
;$ %
set& )
;) *
}+ ,
public		 
string		 
Password		 
{		  
get		! $
;		$ %
set		& )
;		) *
}		+ ,
public

 
string

 
Topic

 
{

 
get

 !
;

! "
set

# &
;

& '
}

( )
} 
} Ý
&C:\tempProjNew\api\Config\Whitelist.cs
	namespace 	
api
 
. 
Config 
; 
public 
class 
	Whitelist 
{ 
public 

static 
List 
< 
string 
> 
AllowedUrls *
{+ ,
get- 0
;0 1
}2 3
=4 5
new6 9
List: >
<> ?
string? E
>E F
{ 
$str  
,  !
$str  
}		 
;		 
}

 è.
3C:\tempProjNew\api\Controllers\AccountController.cs
	namespace 	
api
 
. 
Controllers 
; 
[

 
	Authorize

 
]

 
[ 
Route 

(
 
$str 
) 
] 
public 

class 
AccountController "
:# $!
GenericControllerBase% :
<: ;
ICrudService; G
,G H
GetAccountDtoI V
,V W
CreateAccountDtoX h
,h i
UpdateAccountDtoj z
>z {
{ 
private 
readonly 
RequestHandler '
_requestHandler( 7
;7 8
public 
AccountController  
(  !
ICrudService! -
service. 5
,5 6
RequestHandler7 E
requestHandlerF T
)T U
: 
base 
( 
service 
, 
$str %
)% &
{ 	
_requestHandler 
= 
requestHandler ,
;, -
} 	
[ 	
HttpPut	 
] 
[ 	
Route	 
( 
$str 
) 
] 
public 
ResponseDto 
GetAccountByName +
(+ ,
[, -
FromBody- 5
]5 6
GetAccountByNameDto7 J
usernameK S
)S T
{ 	
return 
ValidateAndProceed %
(% &
( 
) 
=> 
Service 
. %
GetSingleItemByParameters 7
<7 8
GetAccountDto8 E
>E F
(F G
	TableNameG P
,P Q
new 

Dictionary "
<" #
string# )
,) *
object+ 1
>1 2
{3 4
{5 6
$str7 =
,= >
username? G
.G H
NameH L
}M N
}O P
)P Q
,Q R
$" 
$str ,
{, -
username- 5
.5 6
Name6 :
}: ;
"; <
)< =
;= >
} 	
[   	
HttpPut  	 
]   
[!! 	
Route!!	 
(!! 
$str!! 
)!! 
]!! 
public"" 
ResponseDto"" 
GetAccountByEmail"" ,
("", -
[""- .
FromBody"". 6
]""6 7 
GetAccountByEmailDto""8 L
email""M R
)""R S
{## 	
return$$ 
ValidateAndProceed$$ %
($$% &
(%% 
)%% 
=>%% 
Service%% 
.%% %
GetSingleItemByParameters%% 7
<%%7 8
GetAccountDto%%8 E
>%%E F
(%%F G
	TableName%%G P
,%%P Q
new&& 

Dictionary&& "
<&&" #
string&&# )
,&&) *
object&&+ 1
>&&1 2
{&&3 4
{&&5 6
$str&&7 >
,&&> ?
email&&@ E
.&&E F
Email&&F K
}&&L M
}&&N O
)&&O P
,&&P Q
$"'' 
$str'' -
{''- .
email''. 3
.''3 4
Email''4 9
}''9 :
"'': ;
)''; <
;''< =
}(( 	
[** 	
HttpPost**	 
]** 
[++ 	
AllowAnonymous++	 
]++ 
[,, 	
Route,,	 
(,, 
$str,, 
),, 
],, 
public-- 
IActionResult-- 
Login-- "
(--" #
[--# $
FromBody--$ ,
]--, -
LoginDto--. 6
dto--7 :
)--: ;
{.. 	
var// 
token// 
=// 
Service// 
.//  
VerifyLogin//  +
(//+ ,
dto//, /
./// 0
Username//0 8
,//8 9
dto//: =
.//= >
Password//> F
)//F G
;//G H
if00 
(00 
token00 
!=00 
null00 
)00 
{11 
return22 
Ok22 
(22 
new22 
ResponseDto22 )
{22* +
ResponseData22, 8
=229 :
token22; @
}22A B
)22B C
;22C D
}33 
return44 
Unauthorized44 
(44  
new44  #
ResponseDto44$ /
{440 1
MessageToClient442 A
=44B C
$str44D `
}44a b
)44b c
;44c d
}55 	
[88 	
HttpPost88	 
]88 
[99 	
AllowAnonymous99	 
]99 
[:: 	
Route::	 
(:: 
$str:: 
):: 
]:: 
public;; 
ResponseDto;; 
Register;; #
(;;# $
[;;$ %
FromBody;;% -
];;- .
CreateAccountDto;;/ ?
dto;;@ C
);;C D
{<< 	
return== 
ValidateAndProceed== %
(==% &
(==& '
)==' (
=>==) +
Service==, 3
.==3 4
CreateAccount==4 A
(==A B
new==B E

Dictionary==F P
<==P Q
string==Q W
,==W X
object==Y _
>==_ `
{>> 
{?? 
$str?? 
,?? 
dto??  
.??  !
Name??! %
}??% &
,??& '
{@@ 
$str@@ 
,@@  
dto@@! $
.@@$ %
Password@@% -
}@@- .
,@@. /
{AA 
$strAA 
,AA 
dtoAA !
.AA! "
EmailAA" '
}AA' (
}BB 
)BB 
,BB 
$strCC *
)CC* +
;CC+ ,
}DD 	
}EE í7
9C:\tempProjNew\api\Controllers\AccountOfficeController.cs
	namespace 	
api
 
. 
Controllers 
; 
[

 
	Authorize

 

]


 
[ 
Route 
( 
$str 
) 
] 
public 
class #
AccountOfficeController $
:% &!
GenericControllerBase' <
<< =
ICrudService= I
,I J
GetAccountOfficeDtoK ^
,^ _"
CreateAccountOfficeDto` v
,v w#
UpdateAccountOfficeDto	x Ž
>
Ž 
{ 
private 
readonly 
RequestHandler #
_requestHandler$ 3
;3 4
public 
#
AccountOfficeController "
(" #
ICrudService# /
service0 7
,7 8
RequestHandler9 G
requestHandlerH V
)V W
:X Y
baseZ ^
(^ _
service_ f
,f g
$strh x
)x y
{ 
_requestHandler 
= 
requestHandler (
;( )
} 
[ 
HttpPost 
] 
[ 
Route 

(
 
$str  
)  !
]! "
public 

ResponseDto 
LinkAccountToOffice *
(* +
[+ ,
FromBody, 4
]4 5"
CreateAccountOfficeDto6 L
dtoM P
)P Q
{ 
return 
ValidateAndProceed !
(! "
(" #
)# $
=>% '
Service( /
./ 0#
CreateItemWithoutReturn0 G
(G H
	TableNameH Q
,Q R
new 

Dictionary 
< 
string %
,% &
object' -
>- .
{ 
{ 
$str "
," #
dto$ '
.' (

Account_id( 2
}3 4
,4 5
{ 
$str !
,! "
dto# &
.& '
	Office_id' 0
}1 2
,2 3
{ 
$str $
,$ %
dto& )
.) *
Account_rank* 6
}7 8
} 
) 
, 
$" 
$str '
"' (
)( )
;) *
} 
[!! 
HttpPut!! 
]!! 
["" 
Route"" 

(""
 
$str"" *
)""* +
]""+ ,
public## 

ResponseDto##  
GetAccountsForOffice## +
(##+ ,
[##, -
	FromRoute##- 6
]##6 7
int##8 ;
id##< >
)##> ?
{$$ 
return%% 
ValidateAndProceed%% !
(%%! "
(%%" #
)%%# $
=>%%% '
Service%%( /
.%%/ 0 
GetItemsByParameters%%0 D
<%%D E
GetAccountOfficeDto%%E X
>%%X Y
(%%Y Z
	TableName%%Z c
,%%c d
new&& 

Dictionary&& 
<&& 
string&& !
,&&! "
object&&# )
>&&) *
{&&* +
{&&, -
$str&&. 9
,&&9 :
id&&; =
}&&> ?
}&&@ A
)&&A B
,&&B C
$"'' 
$str'' /
{''/ 0
id''0 2
}''2 3
"''3 4
)''4 5
;''5 6
}(( 
[** 
HttpPut** 
]** 
[++ 
Route++ 

(++
 
$str++ *
)++* +
]+++ ,
public,, 

ResponseDto,,  
GetOfficesForAccount,, +
(,,+ ,
[,,, -
	FromRoute,,- 6
],,6 7
int,,8 ;
id,,< >
),,> ?
{-- 
return.. 
ValidateAndProceed.. !
(..! "
(.." #
)..# $
=>..% '
Service..( /
.../ 0 
GetItemsByParameters..0 D
<..D E
GetAccountOfficeDto..E X
>..X Y
(..Y Z
	TableName..Z c
,..c d
new// 

Dictionary// 
<// 
string// %
,//% &
object//' -
>//- .
{//. /
{//0 1
$str//2 >
,//> ?
id//@ B
}//C D
}//E F
)//F G
,//G H
$"00 
$str00 /
{00/ 0
id000 2
}002 3
"003 4
)004 5
;005 6
}11 
[33 

HttpDelete33 
]33 
[44 
Route44 

(44
 
$str44 $
)44$ %
]44% &
public55 

ResponseDto55 #
RemoveAccountFromOffice55 .
(55. /
[55/ 0
FromBody550 8
]558 9"
DeleteAccountOfficeDto55: P
dto55Q T
)55T U
{66 
return77 
ValidateAndProceed77 !
(77! "
(77" #
)77# $
=>77% '
Service77( /
.77/ 0(
DeleteItemWithMultipleParams770 L
(77L M
	TableName77M V
,77V W
new88 

Dictionary88 
<88 
string88 !
,88! "
object88# )
>88) *
{99 
{:: 
$str:: 
,:: 
dto::  #
.::# $

Account_id::$ .
}::/ 0
,::0 1
{;; 
$str;; 
,;; 
dto;; "
.;;" #
	Office_id;;# ,
};;- .
}<< 
)<< 
,<< 
$str<< .
)<<. /
;<</ 0
}== 
[?? 
HttpPut?? 
]?? 
[@@ 
Route@@ 

(@@
 
$str@@ 
)@@ 
]@@  
publicAA 

ResponseDtoAA &
ModifyAccountRankForOfficeAA 1
(AA1 2
[AA2 3
FromBodyAA3 ;
]AA; <"
UpdateAccountOfficeDtoAA= S
dtoAAT W
)AAW X
{BB 
returnCC 
ValidateAndProceedCC !
(CC! "
(CC" #
)CC# $
=>CC% '
ServiceCC( /
.CC/ 0

UpdateItemCC0 :
(CC: ;
	TableNameCC; D
,CCD E
newDD 

DictionaryDD 
<DD 
stringDD !
,DD! "
objectDD# )
>DD) *
{EE 
{FF 
$strFF 
,FF 
dtoFF  #
.FF# $

Account_idFF$ .
}FF/ 0
,FF0 1
{GG 
$strGG 
,GG 
dtoGG "
.GG" #
	Office_idGG# ,
}GG- .
}HH 
,HH 
newHH 

DictionaryHH 
<HH 
stringHH $
,HH$ %
objectHH& ,
>HH, -
{II 
{JJ 
$strJJ  
,JJ  !
dtoJJ" %
.JJ% &
Account_rankJJ& 2
}JJ3 4
}KK 
)KK 
,KK 
$strKK '
)KK' (
;KK( )
}LL 
}MM ¨
2C:\tempProjNew\api\Controllers\DeviceController.cs
	namespace 	
api
 
. 
Controllers 
; 
[

 
	Authorize

 

]


 
[ 
Route 
( 
$str 
) 
] 
public 
class 
DeviceController 
: !
GenericControllerBase  5
<5 6
ICrudService6 B
,B C
GetDeviceDtoD P
,P Q
CreateDeviceDtoR a
,a b
UpdateDeviceDtoc r
>r s
{ 
private 
readonly 
RequestHandler #
_requestHandler$ 3
;3 4
public 

DeviceController 
( 
ICrudService (
service) 0
,0 1
RequestHandler2 @
requestHandlerA O
)O P
:Q R
baseS W
(W X
serviceX _
,_ `
$stra i
)i j
{ 
_requestHandler 
= 
requestHandler (
;( )
} 
[ 
HttpPut 
] 
[ 
Route 

(
 
$str  
)  !
]! "
public 

ResponseDto 

AssignName !
(! "
[" #
	FromRoute# ,
], -
int. 1
id2 4
)4 5
{ 
return 
ValidateAndProceed !
(! "
(" #
)# $
=>% '
Service( /
./ 0%
GetSingleItemByParameters0 I
<I J
GetDeviceDtoJ V
>V W
(W X
	TableNameX a
,a b
new 

Dictionary 
< 
string %
,% &
object' -
>- .
{ 
{ 
$str 
, 
id 
} 
} 
) 
, 
$" 
$str 2
{2 3
id3 5
}5 6
"6 7
)7 8
;8 9
} 
}   ÚQ
7C:\tempProjNew\api\Controllers\GenericControllerBase.cs
	namespace 	
api
 
. 
Controllers 
; 
[		 
	Authorize		 
]		 
[

 
Route

 

(


 
$str

 
)

 
]

 
public 

class !
GenericControllerBase &
<& '
TService' /
,/ 0
TDto1 5
,5 6

TCreateDto7 A
,A B

TUpdateDtoC M
>M N
:O P
ControllerBaseQ _
where 
TService 
: 
ICrudService %
{ 
	protected 
readonly 
TService #
Service$ +
;+ ,
	protected 
readonly 
string !
	TableName" +
;+ ,
public !
GenericControllerBase $
($ %
TService% -
service. 5
,5 6
string7 =
	tableName> G
)G H
{ 	
Service 
= 
service 
; 
	TableName 
= 
	tableName !
;! "
} 	
[ 	
	NonAction	 
] 
private 
static 
bool 
IsUrlAllowed (
(( )
string) /
url0 3
)3 4
{ 	
return 
	Whitelist 
. 
AllowedUrls (
.( )
Any) ,
(, -
url- 0
.0 1

StartsWith1 ;
); <
;< =
} 	
[ 	
	NonAction	 
] 
private 
static 
ResponseDto " 
HandleInvalidRequest# 7
(7 8
)8 9
{ 	
return   
new   
ResponseDto   "
{!! 
MessageToClient"" 
=""  !
$str""" 4
,""4 5
ResponseData## 
=## 
null## #
}$$ 
;$$ 
}%% 	
['' 	
	NonAction''	 
]'' 
	protected(( 
ResponseDto(( 
ValidateAndProceed(( 0
<((0 1
TResult((1 8
>((8 9
(((9 :
Func((: >
<((> ?
TResult((? F
>((F G
action((H N
,((N O
string((P V
successMessage((W e
,((e f
bool((g k
bypassUrlCheck((l z
=(({ |
false	((} ‚
)
((‚ ƒ
{)) 	
if** 
(** 
!** 
bypassUrlCheck** 
&&**  "
!**# $
IsUrlAllowed**$ 0
(**0 1
Request**1 8
.**8 9
Headers**9 @
.**@ A
Referer**A H
)**H I
)**I J
{++ 
return,,  
HandleInvalidRequest,, +
(,,+ ,
),,, -
;,,- .
}-- 
try// 
{00 
var11 
responseData11  
=11! "
action11# )
.11) *
Invoke11* 0
(110 1
)111 2
;112 3
return22 
new22 
ResponseDto22 &
{33 
MessageToClient44 #
=44$ %
$"44& (
$str44( 5
{445 6
successMessage446 D
}44D E
$str44E F
"44F G
,44G H
ResponseData55  
=55! "
responseData55# /
}66 
;66 
}77 
catch88 
(88 
	Exception88 
ex88 
)88  
{99 
Console:: 
.:: 
	WriteLine:: !
(::! "
ex::" $
.::$ %
Message::% ,
)::, -
;::- .
return;; 
new;; 
ResponseDto;; &
{;;' (
MessageToClient;;) 8
=;;9 :
$str;;; m
};;n o
;;;o p
}<< 
}== 	
[?? 	
HttpGet??	 
]?? 
[@@ 	
	Authorize@@	 
]@@ 
[AA 	
RouteAA	 
(AA 
$strAA 
)AA 
]AA 
publicBB 
virtualBB 
ResponseDtoBB "
GetAllItemsBB# .
(BB. /
)BB/ 0
{CC 	
returnDD 
ValidateAndProceedDD %
(DD% &
(DD& '
)DD' (
=>DD) +
ServiceDD, 3
.DD3 4
GetAllItemsDD4 ?
<DD? @
TDtoDD@ D
>DDD E
(DDE F
	TableNameDDF O
)DDO P
,DDP Q
$strEE #
)EE# $
;EE$ %
}FF 	
[HH 	
HttpGetHH	 
]HH 
[II 	
	AuthorizeII	 
]II 
[JJ 	
RouteJJ	 
(JJ 
$strJJ !
)JJ! "
]JJ" #
publicKK 
virtualKK 
ResponseDtoKK "
GetItemByIdKK# .
(KK. /
[KK/ 0
	FromRouteKK0 9
]KK9 :
intKK; >
idKK? A
)KKA B
{LL 	
returnMM 
ValidateAndProceedMM %
(MM% &
(MM& '
)MM' (
=>MM) +
ServiceNN 
.NN %
GetSingleItemByParametersNN 1
<NN1 2
TDtoNN2 6
>NN6 7
(NN7 8
	TableNameNN8 A
,NNA B
newOO 

DictionaryOO "
<OO" #
stringOO# )
,OO) *
objectOO+ 1
>OO1 2
{OO3 4
{OO5 6
$strOO7 ;
,OO; <
idOO= ?
}OO@ A
}OOB C
)OOC D
,OOD E
$"PP 
$strPP '
{PP' (
idPP( *
}PP* +
"PP+ ,
)PP, -
;PP- .
}QQ 	
[SS 	
HttpPostSS	 
]SS 
[TT 	
	AuthorizeTT	 
]TT 
[UU 	
RouteUU	 
(UU 
$strUU 
)UU 
]UU 
publicVV 
virtualVV 
ResponseDtoVV "

CreateItemVV# -
(VV- .
[VV. /
FromBodyVV/ 7
]VV7 8

TCreateDtoVV9 C
dtoVVD G
)VVG H
{WW 	
returnXX 
ValidateAndProceedXX %
(XX% &
(XX& '
)XX' (
=>XX) +
{YY 
varZZ 

parametersZZ 
=ZZ  
dtoZZ! $
.ZZ$ %
GetTypeZZ% ,
(ZZ, -
)ZZ- .
.ZZ. /
GetPropertiesZZ/ <
(ZZ< =
)ZZ= >
.ZZ> ?
ToDictionaryZZ? K
(ZZK L
prop[[ 
=>[[ 
prop[[  
.[[  !
Name[[! %
,[[% &
prop[[' +
=>[[, .
prop[[/ 3
.[[3 4
GetValue[[4 <
([[< =
dto[[= @
,[[@ A
null[[B F
)[[F G
)[[G H
;[[H I
return\\ 
	TableName\\  
==\\! #
$str\\$ -
?\\. /
Service\\0 7
.\\7 8
CreateAccount\\8 E
(\\E F

parameters\\F P
)\\P Q
:\\R S
Service]] 
.]] 

CreateItem]] &
<]]& '
TDto]]' +
>]]+ ,
(]], -
	TableName]]- 6
,]]6 7

parameters]]8 B
)]]B C
;]]C D
}^^ 
,^^ 
$str^^ 
)^^ 
;^^ 
}__ 	
[aa 	
HttpPutaa	 
]aa 
[bb 	
	Authorizebb	 
]bb 
[cc 	
Routecc	 
(cc 
$strcc 
)cc 
]cc 
publicdd 
virtualdd 
ResponseDtodd "

UpdateItemdd# -
(dd- .
[dd. /

FromHeaderdd/ 9
]dd9 :
intdd; >
iddd? A
,ddA B
[ddC D
FromBodyddD L
]ddL M

TUpdateDtoddN X
dtoddY \
)dd\ ]
{ee 	
returnff 
ValidateAndProceedff %
<ff% &
boolff& *
>ff* +
(ff+ ,
(ff, -
)ff- .
=>ff/ 1
{gg 
varhh 
modificationshh !
=hh" #
dtohh$ '
.hh' (
GetTypehh( /
(hh/ 0
)hh0 1
.hh1 2
GetPropertieshh2 ?
(hh? @
)hh@ A
.hhA B
ToDictionaryhhB N
(hhN O
propii 
=>ii 
propii  
.ii  !
Nameii! %
,ii% &
propii' +
=>ii, .
propii/ 3
.ii3 4
GetValueii4 <
(ii< =
dtoii= @
,ii@ A
nulliiB F
)iiF G
)iiG H
;iiH I
varjj 
conditionColumnsjj $
=jj% &
newjj' *

Dictionaryjj+ 5
<jj5 6
stringjj6 <
,jj< =
objectjj> D
>jjD E
{jjF G
{jjH I
$strjjJ N
,jjN O
idjjP R
}jjS T
}jjU V
;jjV W
returnll 
	TableNamell  
==ll! #
$strll$ -
?ll. /
Servicell0 7
.ll7 8
UpdateAccountll8 E
(llE F
conditionColumnsllF V
,llV W
modificationsllX e
)lle f
:llg h
Servicemm 
.mm 

UpdateItemmm &
(mm& '
	TableNamemm' 0
,mm0 1
conditionColumnsmm2 B
,mmB C
modificationsmmD Q
)mmQ R
;mmR S
}nn 
,nn 
$strnn 
)nn 
;nn 
}oo 	
[rr 	

HttpDeleterr	 
]rr 
[ss 	
	Authorizess	 
]ss 
[tt 	
Routett	 
(tt 
$strtt  
)tt  !
]tt! "
publicuu 
virtualuu 
ResponseDtouu "

DeleteItemuu# -
(uu- .
[uu. /
	FromRouteuu/ 8
]uu8 9
intuu: =
iduu> @
)uu@ A
{vv 	
returnww 
ValidateAndProceedww %
(ww% &
(ww& '
)ww' (
=>ww) +
Serviceww, 3
.ww3 4

DeleteItemww4 >
(ww> ?
	TableNameww? H
,wwH I
idwwJ L
)wwL M
,wwM N
$strxx 4
)xx4 5
;xx5 6
}yy 	
}zz Ø!
0C:\tempProjNew\api\Controllers\LogsController.cs
	namespace 	
api
 
. 
Controllers 
; 
[

 
	Authorize

 

]


 
[ 
Route 
( 
$str 
) 
] 
public 
class 
LogsController 
: !
GenericControllerBase 3
<3 4
ICrudService4 @
,@ A

GetLogsDtoB L
,L M
CreateLogsDtoN [
,[ \
UpdateLogsDto] j
>j k
{ 
private 
readonly 
RequestHandler #
_requestHandler$ 3
;3 4
public 

LogsController 
( 
ICrudService &
service' .
,. /
RequestHandler0 >
requestHandler? M
)M N
:O P
baseQ U
(U V
serviceV ]
,] ^
$str_ j
)j k
{ 
_requestHandler 
= 
requestHandler (
;( )
} 
[ 
HttpPut 
] 
[ 
Route 

(
 
$str 
) 
] 
public 

ResponseDto 
GetLogsForOffice '
(' (
[( )
FromBody) 1
]1 2
int3 6
id7 9
)9 :
{ 
return 
ValidateAndProceed !
(! "
( 
) 
=> 
Service 
. %
GetSingleItemByParameters 3
<3 4

GetLogsDto4 >
>> ?
(? @
	TableName@ I
,I J
new 

Dictionary 
< 
string %
,% &
object' -
>- .
{/ 0
{1 2
$str3 >
,> ?
id@ B
}C D
}E F
)F G
,G H
$" 
$str '
{' (
id( *
}* +
"+ ,
), -
;- .
} 
[ 
HttpPut 
] 
[ 
Route 

(
 
$str 
) 
] 
public   

ResponseDto   
GetLogsForRoom   %
(  % &
[  & '
FromBody  ' /
]  / 0
int  1 4
id  5 7
)  7 8
{!! 
return"" 
ValidateAndProceed"" !
(""! "
(## 
)## 
=>## 
Service## 
.## %
GetSingleItemByParameters## 3
<##3 4

GetLogsDto##4 >
>##> ?
(##? @
	TableName##@ I
,##I J
new$$ 

Dictionary$$ 
<$$ 
string$$ %
,$$% &
object$$' -
>$$- .
{$$/ 0
{$$1 2
$str$$3 <
,$$< =
id$$> @
}$$A B
}$$C D
)$$D E
,$$E F
$"%% 
$str%% %
{%%% &
id%%& (
}%%( )
"%%) *
)%%* +
;%%+ ,
}&& 
[(( 
HttpPut(( 
](( 
[)) 
Route)) 

())
 
$str)) 
))) 
]))  
public** 

ResponseDto** 
GetLogsForAccount** (
(**( )
[**) *
FromBody*** 2
]**2 3
int**4 7
id**8 :
)**: ;
{++ 
return,, 
ValidateAndProceed,, !
(,,! "
(-- 
)-- 
=>-- 
Service-- 
.-- %
GetSingleItemByParameters-- 3
<--3 4

GetLogsDto--4 >
>--> ?
(--? @
	TableName--@ I
,--I J
new.. 

Dictionary.. 
<.. 
string.. %
,..% &
object..' -
>..- .
{../ 0
{..1 2
$str..3 ?
,..? @
id..A C
}..D E
}..F G
)..G H
,..H I
$"// 
$str// (
{//( )
id//) +
}//+ ,
"//, -
)//- .
;//. /
}00 
}11 í/
0C:\tempProjNew\api\Controllers\MqttController.cs
	namespace

 	
api


 
.

 
Controllers

 
{ 
[ 
ApiController 
] 
[ 
	Authorize 
] 
[ 
Route 

(
 
$str 
) 
] 
public 

class 
MqttController 
:  !
ControllerBase" 0
{ 
private 
readonly 
MqttService $
_mqttService% 1
;1 2
private 
readonly 
WebSocketServer (
_webSocketServer) 9
;9 :
public 
MqttController 
( 
MqttService )
mqttService* 5
,5 6
WebSocketServer7 F
webSocketServerG V
)V W
{ 	
_mqttService 
= 
mqttService &
;& '
_webSocketServer 
= 
webSocketServer .
;. /
} 	
[ 	
HttpPost	 
( 
$str 
) 
] 
public 
async 
Task 
< 
IActionResult '
>' (
	Subscribe) 2
(2 3
[3 4
FromBody4 <
]< =
string> D
topicE J
)J K
{ 	
try 
{ 
if 
( 
string 
. 
IsNullOrEmpty (
(( )
topic) .
). /
)/ 0
{   
throw!! 
new!! 
ValidationException!! 1
(!!1 2
$str!!2 R
)!!R S
;!!S T
}"" 
await$$ 
_mqttService$$ "
.$$" #
SubscribeAsync$$# 1
($$1 2
topic$$2 7
)$$7 8
;$$8 9
return%% 
Ok%% 
(%% 
new%% 
{%% 
Message%%  '
=%%( )
$"%%* ,
$str%%, @
{%%@ A
topic%%A F
}%%F G
"%%G H
}%%I J
)%%J K
;%%K L
}&& 
catch'' 
('' 
	Exception'' 
ex'' 
)''  
{(( 
throw)) 
new)) 

Exceptions)) $
.))$ %#
QueryExecutionException))% <
())< =
$str))= ^
,))^ _
ex))` b
)))b c
;))c d
}** 
}++ 	
[-- 	
HttpPost--	 
(-- 
$str-- 
)--  
]--  !
public.. 
async.. 
Task.. 
<.. 
IActionResult.. '
>..' (
Unsubscribe..) 4
(..4 5
[..5 6
FromBody..6 >
]..> ?
string..@ F
topic..G L
)..L M
{// 	
try00 
{11 
if22 
(22 
string22 
.22 
IsNullOrEmpty22 (
(22( )
topic22) .
)22. /
)22/ 0
{33 
throw44 
new44 
ValidationException44 1
(441 2
$str442 R
)44R S
;44S T
}55 
await77 
_mqttService77 "
.77" #
UnsubscribeAsync77# 3
(773 4
topic774 9
)779 :
;77: ;
return88 
Ok88 
(88 
new88 
{88 
Message88  '
=88( )
$"88* ,
$str88, D
{88D E
topic88E J
}88J K
"88K L
}88M N
)88N O
;88O P
}99 
catch:: 
(:: 
	Exception:: 
ex:: 
)::  
{;; 
throw<< 
new<< 

Exceptions<< $
.<<$ %#
QueryExecutionException<<% <
(<<< =
$str<<= b
,<<b c
ex<<d f
)<<f g
;<<g h
}== 
}>> 	
[@@ 	
HttpPost@@	 
(@@ 
$str@@ $
)@@$ %
]@@% &
publicAA 
asyncAA 
TaskAA 
<AA 
IActionResultAA '
>AA' (
PostRoomSettingsAA) 9
(AA9 :
[AA: ;
FromBodyAA; C
]AAC D
RoomSettingsDtoAAE T
roomSettingsAAU a
)AAa b
{BB 	
tryCC 
{DD 
ifEE 
(EE 
roomSettingsEE  
==EE! #
nullEE$ (
)EE( )
{FF 
throwGG 
newGG 
ValidationExceptionGG 1
(GG1 2
$strGG2 Q
)GGQ R
;GGR S
}HH 
ifJJ 
(JJ 
stringJJ 
.JJ 
IsNullOrEmptyJJ (
(JJ( )
roomSettingsJJ) 5
.JJ5 6
TopicJJ6 ;
)JJ; <
)JJ< =
{KK 
throwLL 
newLL 
ValidationExceptionLL 1
(LL1 2
$strLL2 R
)LLR S
;LLS T
}MM 
varOO 
messageOO 
=OO 
JsonSerializerOO ,
.OO, -
	SerializeOO- 6
(OO6 7
roomSettingsOO7 C
)OOC D
;OOD E
awaitQQ 
_mqttServiceQQ "
.QQ" #
PublishAsyncQQ# /
(QQ/ 0
roomSettingsQQ0 <
.QQ< =
TopicQQ= B
,QQB C
messageQQD K
)QQK L
;QQL M
returnSS 
OkSS 
(SS 
newSS 
{SS 
MessageSS  '
=SS( )
$strSS* Y
}SSZ [
)SS[ \
;SS\ ]
}TT 
catchUU 
(UU 
	ExceptionUU 
exUU 
)UU  
{VV 
throwWW 
newWW 

ExceptionsWW $
.WW$ %#
QueryExecutionExceptionWW% <
(WW< =
$strWW= f
,WWf g
exWWh j
)WWj k
;WWk l
}XX 
}YY 	
}ZZ 
}[[ µ
2C:\tempProjNew\api\Controllers\OfficeController.cs
	namespace		 	
api		
 
.		 
Controllers		 
;		 
[ 
	Authorize 

]
 
[ 
Route 
( 
$str 
) 
] 
public 
class 
OfficeController 
: !
GenericControllerBase  5
<5 6
ICrudService6 B
,B C
GetOfficeDtoD P
,P Q
CreateOfficeDtoR a
,a b
UpdateOfficeDtoc r
>r s
{ 
private 
readonly 
RequestHandler #
_requestHandler$ 3
;3 4
public 

OfficeController 
( 
ICrudService (
service) 0
,0 1
RequestHandler2 @
requestHandlerA O
)O P
:Q R
baseS W
(W X
serviceX _
,_ `
$stra i
)i j
{ 
_requestHandler 
= 
requestHandler (
;( )
} 
[ 
HttpPut 
] 
[ 
Route 

(
 
$str 
) 
] 
public 

ResponseDto 
GetOfficeByName &
(& '
[' (
FromBody( 0
]0 1
string2 8
name9 =
)= >
{ 
return 
ValidateAndProceed !
(! "
( 
) 
=> 
Service 
. %
GetSingleItemByParameters 3
<3 4
GetOfficeDto4 @
>@ A
(A B
	TableNameB K
,K L
new 

Dictionary 
< 
string %
,% &
object' -
>- .
{/ 0
{1 2
$str3 9
,9 :
name; ?
}@ A
}B C
)C D
,D E
$" 
$str '
{' (
name( ,
}, -
"- .
). /
;/ 0
} 
} Ñ4
0C:\tempProjNew\api\Controllers\RoomController.cs
	namespace 	
api
 
. 
Controllers 
; 
[ 
	Authorize 

]
 
[ 
Route 
( 
$str 
) 
] 
public 
class 
RoomController 
: !
GenericControllerBase 3
<3 4
ICrudService4 @
,@ A

GetRoomDtoB L
,L M
CreateRoomDtoN [
,[ \
UpdateRoomDto] j
>j k
{ 
private 
readonly 
RequestHandler #
_requestHandler$ 3
;3 4
public 

RoomController 
( 
ICrudService &
service' .
,. /
RequestHandler0 >
requestHandler? M
)M N
: 	
base
 
( 
service 
, 
$str 
) 
{ 
_requestHandler 
= 
requestHandler (
;( )
} 
[ 
HttpPut 
] 
[ 
Route 

(
 
$str 
) 
] 
public 

ResponseDto 
GetRoomByName $
($ %
[% &
FromBody& .
]. /
string0 6
name7 ;
); <
{ 
return 
ValidateAndProceed !
(! "
( 
) 
=> 
Service 
. %
GetSingleItemByParameters 3
<3 4

GetRoomDto4 >
>> ?
(? @
	TableName@ I
,I J
new 

Dictionary 
< 
string %
,% &
object' -
>- .
{/ 0
{1 2
$str3 9
,9 :
name; ?
}@ A
}B C
)C D
,D E
$"   
$str   %
{  % &
name  & *
}  * +
"  + ,
)  , -
;  - .
}!! 
[## 
HttpPut## 
]## 
[$$ 
Route$$ 

($$
 
$str$$ '
)$$' (
]$$( )
public%% 

ResponseDto%% 
GetRoomsForOffice%% (
(%%( )
[%%) *
	FromRoute%%* 3
]%%3 4
int%%5 8
id%%9 ;
)%%; <
{&& 
return'' 
ValidateAndProceed'' !
(''! "
((( 
)(( 
=>(( 
Service(( 
.((  
GetItemsByParameters(( .
<((. /

GetRoomDto((/ 9
>((9 :
(((: ;
	TableName((; D
,((D E
new)) 

Dictionary)) 
<)) 
string)) %
,))% &
object))' -
>))- .
{))/ 0
{))1 2
$str))3 >
,))> ?
id))@ B
}))C D
}))E F
)))F G
,))G H
$"** 
$str** (
{**( )
id**) +
}**+ ,
"**, -
)**- .
;**. /
}++ 
[-- 
HttpPut-- 
]-- 
[.. 
Route.. 

(..
 
$str.. 
).. 
]..  
public// 

ResponseDto// 
UpdateTemperature// (
(//( )
[//) *
FromBody//* 2
]//2 3 
UpdateTemperatureDto//4 H
dto//I L
)//L M
{00 
try11 
{22 	
var44 
	officeDto44 
=44 
Service44 #
.44# $%
GetSingleItemByParameters44$ =
<44= >
GetOfficeDto44> J
>44J K
(44K L
$str44L T
,44T U
new55 

Dictionary55 
<55 
string55 %
,55% &
object55' -
>55- .
{66 
{77 
$str77 
,77 
dto77 !
.77! "
Office_name77" -
}77. /
}88 
)88 
;88 
if:: 
(:: 
	officeDto:: 
==:: 
null:: !
)::! "
{;; 
throw<< 
new<<  
KeyNotFoundException<< .
(<<. /
$"<</ 1
$str<<1 C
{<<C D
dto<<D G
.<<G H
Office_name<<H S
}<<S T
$str<<T `
"<<` a
)<<a b
;<<b c
}== 
var?? 
officeId?? 
=?? 
	officeDto?? $
.??$ %
Id??% '
;??' (
varBB 
updateResultBB 
=BB 
ServiceBB &
.BB& '

UpdateItemBB' 1
(BB1 2
$strBB2 8
,BB8 9
newCC 

DictionaryCC 
<CC 
stringCC %
,CC% &
objectCC' -
>CC- .
{DD 
{EE 
$strEE 
,EE 
dtoEE !
.EE! "
NameEE" &
}EE' (
,EE( )
{FF 
$strFF !
,FF! "
officeIdFF# +
}FF, -
}GG 
,GG 
newHH 

DictionaryHH 
<HH 
stringHH %
,HH% &
objectHH' -
>HH- .
{II 
{JJ 
$strJJ $
,JJ$ %
dtoJJ& )
.JJ) *
Desired_tempJJ* 6
}JJ7 8
,JJ8 9
{KK 
$strKK %
,KK% &
dtoKK' *
.KK* +
Window_toggleKK+ 8
}KK9 :
}LL 
)LL 
;LL 
ifNN 
(NN 
!NN 
updateResultNN 
)NN 
{OO 
throwPP 
newPP 

ExceptionsPP $
.PP$ %#
QueryExecutionExceptionPP% <
(PP< =
$strPP= ^
,PP^ _
newPP` c
	ExceptionPPd m
(PPm n
)PPn o
)PPo p
;PPp q
}QQ 
returnSS 
newSS 
ResponseDtoSS "
{TT 
MessageToClientUU 
=UU  !
$"UU" $
$strUU$ B
{UUB C
dtoUUC F
.UUF G
NameUUG K
}UUK L
"UUL M
}VV 
;VV 
}WW 	
catchXX 
(XX 
	ExceptionXX 
exXX 
)XX 
{YY 	
throwZZ 
newZZ 

ExceptionsZZ  
.ZZ  !#
QueryExecutionExceptionZZ! 8
(ZZ8 9
$strZZ9 _
,ZZ_ `
exZZa c
)ZZc d
;ZZd e
}[[ 	
}\\ 
}]] 
:C:\tempProjNew\api\Controllers\UserPreferenceController.cs
	namespace 	
api
 
. 
Controllers 
; 
[ 
	Authorize 

]
 
[ 
Route 
( 
$str 
) 
] 
public		 
class		 $
UserPreferenceController		 %
{

 
} ð	
?C:\tempProjNew\api\DTOs\AccountOffice\CreateAccountOfficeDto.cs
	namespace 	
api
 
. 
DTOs 
. 
AccountOffice  
;  !
public 
class "
CreateAccountOfficeDto #
{ 
public 
"
CreateAccountOfficeDto !
(! "
int" %

account_id& 0
,0 1
int2 5
	office_id6 ?
,? @
intA D
account_rankE Q
)Q R
{ 

Account_id 
= 

account_id 
;  
	Office_id 
= 
	office_id 
; 
Account_rank		 
=		 
account_rank		 #
;		# $
}

 
public 

int 

Account_id 
{ 
get 
;  
set! $
;$ %
}& '
public 

int 
	Office_id 
{ 
get 
; 
set  #
;# $
}% &
public 

int 
Account_rank 
{ 
get !
;! "
set# &
;& '
}( )
} Ç
?C:\tempProjNew\api\DTOs\AccountOffice\DeleteAccountOfficeDto.cs
	namespace 	
api
 
. 
DTOs 
. 
AccountOffice  
;  !
public 
class "
DeleteAccountOfficeDto #
{ 
public 
"
DeleteAccountOfficeDto !
(! "
int" %

account_id& 0
,0 1
int2 5
	office_id6 ?
)? @
{ 

Account_id 
= 

account_id 
;  
	Office_id 
= 
	office_id 
; 
}		 
public 

int 

Account_id 
{ 
get 
;  
set! $
;$ %
}& '
public 

int 
	Office_id 
{ 
get 
; 
set  #
;# $
}% &
} ç	
<C:\tempProjNew\api\DTOs\AccountOffice\GetAccountOfficeDto.cs
	namespace 	
api
 
. 
DTOs 
. 
AccountOffice  
;  !
public 
class 
GetAccountOfficeDto  
{ 
public 

GetAccountOfficeDto 
( 
int "

account_id# -
,- .
int/ 2
	office_id3 <
,< =
int> A
account_rankB N
)N O
{ 

Account_id 
= 

account_id 
;  
	Office_id 
= 
	office_id 
; 
Account_rank		 
=		 
account_rank		 #
;		# $
}

 
public 

int 

Account_id 
{ 
get 
;  
set! $
;$ %
}& '
public 

int 
	Office_id 
{ 
get 
; 
set  #
;# $
}% &
public 

int 
Account_rank 
{ 
get !
;! "
set# &
;& '
}( )
} ð	
?C:\tempProjNew\api\DTOs\AccountOffice\UpdateAccountOfficeDto.cs
	namespace 	
api
 
. 
DTOs 
. 
AccountOffice  
;  !
public 
class "
UpdateAccountOfficeDto #
{ 
public 
"
UpdateAccountOfficeDto !
(! "
int" %

account_id& 0
,0 1
int2 5
	office_id6 ?
,? @
intA D
account_rankE Q
)Q R
{ 

Account_id 
= 

account_id 
;  
	Office_id 
= 
	office_id 
; 
Account_rank		 
=		 
account_rank		 #
;		# $
}

 
public 

int 

Account_id 
{ 
get 
;  
set! $
;$ %
}& '
public 

int 
	Office_id 
{ 
get 
; 
set  #
;# $
}% &
public 

int 
Account_rank 
{ 
get !
;! "
set# &
;& '
}( )
} ¬	
3C:\tempProjNew\api\DTOs\Account\CreateAccountDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Account 
; 
public 
class 
CreateAccountDto 
{ 
public 

CreateAccountDto 
( 
string "
name# '
,' (
string) /
password0 8
,8 9
string: @
emailA F
)F G
{ 
Name		 
=		 
name		 
;		 
Email

 
=

 
email

 
;

 
Password 
= 
password 
; 
} 
public 

string 
Name 
{ 
get 
; 
set !
;! "
}# $
public 

string 
Password 
{ 
get  
;  !
set" %
;% &
}' (
public 

string 
Email 
{ 
get 
; 
set "
;" #
}$ %
} ­
7C:\tempProjNew\api\DTOs\Account\GetAccountByEmailDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Account 
; 
public 
class  
GetAccountByEmailDto !
{ 
public 

string 
Email 
{ 
get 
; 
set "
;" #
}$ %
} ª
6C:\tempProjNew\api\DTOs\Account\GetAccountByNameDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Account 
; 
public 
class 
GetAccountByNameDto  
{ 
public 

string 
Name 
{ 
get 
; 
set !
;! "
}# $
} Ê
0C:\tempProjNew\api\DTOs\Account\GetAccountDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Account 
; 
public 
class 
GetAccountDto 
{ 
public 

int 
Id 
{ 
get 
; 
set 
; 
} 
public 

string 
Name 
{ 
get 
; 
set !
;! "
}# $
public		 

string		 
Email		 
{		 
get		 
;		 
set		 "
;		" #
}		$ %
}

 ‘
+C:\tempProjNew\api\DTOs\Account\LoginDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Account 
; 
public 
class 
LoginDto 
{ 
public 

LoginDto 
( 
string 
username #
,# $
string% +
password, 4
)4 5
{ 
Username		 
=		 
username		 
;		 
Password

 
=

 
password

 
;

 
} 
public 

string 
Username 
{ 
get  
;  !
set" %
;% &
}' (
public 

string 
Password 
{ 
get  
;  !
set" %
;% &
}' (
} ½	
3C:\tempProjNew\api\DTOs\Account\UpdateAccountDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Account 
{ 
public 

class 
UpdateAccountDto !
{ 
public 
UpdateAccountDto 
(  
string  &
name' +
,+ ,
string- 3
password4 <
,< =
string> D
emailE J
)J K
{ 	
Name 
= 
name 
; 
Email 
= 
email 
; 
Password		 
=		 
password		 
;		  
}

 	
public 
string 
Name 
{ 
get  
;  !
set" %
;% &
}' (
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
} 
} ª
/C:\tempProjNew\api\DTOs\Device\AssignNameDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Device 
; 
public 
class 
AssignNameDto 
{ 
public 

AssignNameDto 
( 
string 

officeName  *
,* +
string, 2
roomName3 ;
); <
{ 
Office_name 
= 

officeName  
;  !
	Room_name 
= 
roomName 
; 
}		 
public 

string 
Office_name 
{ 
get  #
;# $
set% (
;( )
}* +
public 

string 
	Room_name 
{ 
get !
;! "
set# &
;& '
}( )
} ”
1C:\tempProjNew\api\DTOs\Device\CreateDeviceDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Device 
; 
public 
class 
CreateDeviceDto 
{ 
public 

CreateDeviceDto 
( 
int 
officeId '
,' (
int) ,
roomId- 3
)3 4
{ 
	Office_id 
= 
officeId 
; 
Room_id 
= 
roomId 
; 
}		 
public 

int 
	Office_id 
{ 
get 
; 
set  #
;# $
}% &
public 

int 
Room_id 
{ 
get 
; 
set !
;! "
}# $
} Œ	
.C:\tempProjNew\api\DTOs\Device\GetDeviceDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Device 
; 
public 
class 
GetDeviceDto 
{ 
public 

GetDeviceDto 
( 
int 
id 
, 
int  #
officeId$ ,
,, -
int. 1
roomId2 8
)8 9
{ 
Id 

= 
id 
; 
	Office_id 
= 
officeId 
; 
Room_id		 
=		 
roomId		 
;		 
}

 
public 

int 
Id 
{ 
get 
; 
set 
; 
} 
public 

int 
	Office_id 
{ 
get 
; 
set  #
;# $
}% &
public 

int 
Room_id 
{ 
get 
; 
set !
;! "
}# $
} •	
1C:\tempProjNew\api\DTOs\Device\UpdateDeviceDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Device 
; 
public 
class 
UpdateDeviceDto 
{ 
public 

UpdateDeviceDto 
( 
int 
id !
,! "
int# &
officeId' /
,/ 0
int1 4
roomId5 ;
); <
{ 
Id 

= 
id 
; 
	Office_id 
= 
officeId 
; 
Room_id		 
=		 
roomId		 
;		 
}

 
public 

int 
Id 
{ 
get 
; 
set 
; 
} 
public 

int 
	Office_id 
{ 
get 
; 
set  #
;# $
}% &
public 

int 
Room_id 
{ 
get 
; 
set !
;! "
}# $
} Î
1C:\tempProjNew\api\DTOs\LogTable\CreateLogsDto.cs
	namespace 	
api
 
. 
DTOs 
. 
LogTable 
; 
public 
class 
CreateLogsDto 
{ 
public 

CreateLogsDto 
( 
string 
action  &
,& '
int( +
room_id, 3
,3 4
int5 8
	office_id9 B
,B C
intD G

account_idH R
)R S
{ 
Action 
= 
action 
; 
Room_id 
= 
room_id 
; 
	Office_id		 
=		 
	office_id		 
;		 

Account_id

 
=

 

account_id

 
;

  
} 
public 

int 

Account_id 
{ 
get 
;  
set! $
;$ %
}& '
public 

int 
	Office_id 
{ 
get 
; 
set  #
;# $
}% &
public 

int 
Room_id 
{ 
get 
; 
set !
;! "
}# $
public 

string 
Action 
{ 
get 
; 
set  #
;# $
}% &
} ®
.C:\tempProjNew\api\DTOs\LogTable\GetLogsDto.cs
	namespace 	
api
 
. 
DTOs 
. 
LogTable 
; 
public 
class 

GetLogsDto 
{ 
public 


GetLogsDto 
( 
) 
{ 
} 
public 


GetLogsDto 
( 
int 
id 
, 
string $
action% +
,+ ,
int- 0
room_id1 8
,8 9
int: =
	office_id> G
,G H
intI L

account_idM W
)W X
{ 
Id 

= 
id 
; 
Action		 
=		 
action		 
;		 
Room_id

 
=

 
room_id

 
;

 
	Office_id 
= 
	office_id 
; 

Account_id 
= 

account_id 
;  
} 
public 

int 
Id 
{ 
get 
; 
set 
; 
} 
public 

int 

Account_id 
{ 
get 
;  
set! $
;$ %
}& '
public 

int 
	Office_id 
{ 
get 
; 
set  #
;# $
}% &
public 

int 
Room_id 
{ 
get 
; 
set !
;! "
}# $
public 

string 
Action 
{ 
get 
; 
set  #
;# $
}% &
} Î
1C:\tempProjNew\api\DTOs\LogTable\UpdateLogsDto.cs
	namespace 	
api
 
. 
DTOs 
. 
LogTable 
; 
public 
class 
UpdateLogsDto 
{ 
public 

UpdateLogsDto 
( 
string 
action  &
,& '
int( +
room_id, 3
,3 4
int5 8
	office_id9 B
,B C
intD G

account_idH R
)R S
{ 
Action 
= 
action 
; 
Room_id 
= 
room_id 
; 
	Office_id		 
=		 
	office_id		 
;		 

Account_id

 
=

 

account_id

 
;

  
} 
public 

int 

Account_id 
{ 
get 
;  
set! $
;$ %
}& '
public 

int 
	Office_id 
{ 
get 
; 
set  #
;# $
}% &
public 

int 
Room_id 
{ 
get 
; 
set !
;! "
}# $
public 

string 
Action 
{ 
get 
; 
set  #
;# $
}% &
} ²

0C:\tempProjNew\api\DTOs\Mqtt\DeviceMessageDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Mqtt 
; 
public 
class 
DeviceMessageDto 
{ 
[ 
JsonPropertyName 
( 
$str )
)) *
]* +
public 

float 
TargetTemperature "
{# $
get% (
;( )
set* -
;- .
}/ 0
[

 
JsonPropertyName

 
(

 
$str

 (
)

( )
]

) *
public 

float 
HumidityTreshold !
{" #
get$ '
;' (
set) ,
;, -
}. /
[ 
JsonPropertyName 
( 
$str #
)# $
]$ %
public 

float 
HumidityMax 
{ 
get "
;" #
set$ '
;' (
}) *
[ 
JsonPropertyName 
( 
$str 
) 
]  
public 

int 
Toggle 
{ 
get 
; 
set  
;  !
}" #
} ï	
/C:\tempProjNew\api\DTOs\Mqtt\RoomSettingsDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Mqtt 
{ 
public 

class 
RoomSettingsDto  
{ 
public 
string 
Source 
{ 
get "
;" #
set$ '
;' (
}) *
=+ ,
$str- 5
;5 6
public 
int 
TargetTemperature $
{% &
get' *
;* +
set, /
;/ 0
}1 2
public 
int 
HumidityThreshold $
{% &
get' *
;* +
set, /
;/ 0
}1 2
public 
int 
HumidityMax 
{  
get! $
;$ %
set& )
;) *
}+ ,
public		 
int		 
Toggle		 
{		 
get		 
;		  
set		! $
;		$ %
}		& '
public

 
string

 
Topic

 
{

 
get

 !
;

! "
set

# &
;

& '
}

( )
} 
} ‡
4C:\tempProjNew\api\DTOs\Mqtt\UpdateTemperatureDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Mqtt 
; 
public 
class  
UpdateTemperatureDto !
{ 
public 

string 
Name 
{ 
get 
; 
} 
public 

string 
Office_name 
{ 
get  #
;# $
}% &
public 

float 
Desired_temp 
{ 
get  #
;# $
}% &
public 

bool 
Window_toggle 
{ 
get  #
;# $
}% &
public

 
 
UpdateTemperatureDto

 
(

  
string

  &
name

' +
,

+ ,
string

- 3
office_name

4 ?
,

? @
float

A F
desired_temp

G S
,

S T
bool

U Y
window_toggle

Z g
)

g h
{ 
Name 
= 
name 
; 
Office_name 
= 
office_name !
;! "
Desired_temp 
= 
desired_temp #
;# $
Window_toggle 
= 
window_toggle %
;% &
} 
} ¨
1C:\tempProjNew\api\DTOs\Office\CreateOfficeDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Office 
; 
public 
class 
CreateOfficeDto 
{ 
public 

CreateOfficeDto 
( 
string !
name" &
,& '
string( .
location/ 7
)7 8
{ 
Name		 
=		 
name		 
;		 
Location

 
=

 
location

 
;

 
} 
[ 
Required 
( 
ErrorMessage 
= 
$str 6
)6 7
]7 8
[ 
StringLength 
( 
$num 
, 
ErrorMessage #
=$ %
$str& Q
,Q R
MinimumLengthS `
=a b
$numc d
)d e
]e f
public 

string 
Name 
{ 
get 
; 
set !
;! "
}# $
[ 
Required 
( 
ErrorMessage 
= 
$str :
): ;
]; <
[ 
StringLength 
( 
$num 
, 
ErrorMessage #
=$ %
$str& U
,U V
MinimumLengthW d
=e f
$numg h
)h i
]i j
public 

string 
Location 
{ 
get  
;  !
set" %
;% &
}' (
} Œ	
.C:\tempProjNew\api\DTOs\Office\GetOfficeDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Office 
; 
public 
class 
GetOfficeDto 
{ 
public 

GetOfficeDto 
( 
int 
id 
, 
string  &
name' +
,+ ,
string- 3
location4 <
)< =
{ 
Id 

= 
id 
; 
Name 
= 
name 
; 
Location		 
=		 
location		 
;		 
}

 
public 

int 
Id 
{ 
get 
; 
set 
; 
} 
public 

string 
Name 
{ 
get 
; 
set !
;! "
}# $
public 

string 
Location 
{ 
get  
;  !
set" %
;% &
}' (
} ¨
1C:\tempProjNew\api\DTOs\Office\UpdateOfficeDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Office 
; 
public 
class 
UpdateOfficeDto 
{ 
public 

UpdateOfficeDto 
( 
string !
name" &
,& '
string( .
location/ 7
)7 8
{ 
Name		 
=		 
name		 
;		 
Location

 
=

 
location

 
;

 
} 
[ 
Required 
( 
ErrorMessage 
= 
$str 6
)6 7
]7 8
[ 
StringLength 
( 
$num 
, 
ErrorMessage #
=$ %
$str& Q
,Q R
MinimumLengthS `
=a b
$numc d
)d e
]e f
public 

string 
Name 
{ 
get 
; 
set !
;! "
}# $
[ 
Required 
( 
ErrorMessage 
= 
$str :
): ;
]; <
[ 
StringLength 
( 
$num 
, 
ErrorMessage #
=$ %
$str& U
,U V
MinimumLengthW d
=e f
$numg h
)h i
]i j
public 

string 
Location 
{ 
get  
;  !
set" %
;% &
}' (
} ¨
&C:\tempProjNew\api\DTOs\ResponseDto.cs
	namespace 	
api
 
. 
DTOs 
; 
public 
class 
ResponseDto 
{ 
public 

string 
MessageToClient !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 

Object 
? 
ResponseData 
{  !
get" %
;% &
set' *
;* +
}, -
} Ú
-C:\tempProjNew\api\DTOs\Room\CreateRoomDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Room 
; 
public 
class 
CreateRoomDto 
{ 
public 

CreateRoomDto 
( 
int 
	office_id &
,& '
string( .
name/ 3
,3 4
bool5 9$
physical_overlay_enabled: R
,R S
doubleT Z
desired_temp[ g
,g h
bool 
window_toggle 
, 
int 
req_rank  (
)( )
{ 
	Office_id 
= 
	office_id 
; 
Name		 
=		 
name		 
;		 $
Physical_overlay_enabled

  
=

! "$
physical_overlay_enabled

# ;
;

; <
Desired_temp 
= 
desired_temp #
;# $
Window_toggle 
= 
window_toggle %
;% &
Req_rank 
= 
req_rank 
; 
} 
public 

int 
	Office_id 
{ 
get 
; 
set  #
;# $
}% &
public 

string 
Name 
{ 
get 
; 
set !
;! "
}# $
public 

bool $
Physical_overlay_enabled (
{) *
get+ .
;. /
set0 3
;3 4
}5 6
public 

double 
Desired_temp 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 

bool 
Window_toggle 
{ 
get  #
;# $
set% (
;( )
}* +
public 

int 
Req_rank 
{ 
get 
; 
set "
;" #
}$ %
} ²
0C:\tempProjNew\api\DTOs\Room\DeviceMessageDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Room 
; 
public 
class 
DeviceMessageDto 
{ 
[ 
JsonPropertyName 
( 
$str 
) 
]  
public 

string 
Source 
{ 
get 
; 
set  #
;# $
}% &
[

 
JsonPropertyName

 
(

 
$str

 )
)

) *
]

* +
public 

int 
TargetTemperature  
{! "
get# &
;& '
set( +
;+ ,
}- .
[ 
JsonPropertyName 
( 
$str (
)( )
]) *
public 

int 
HumidityTreshold 
{  !
get" %
;% &
set' *
;* +
}, -
[ 
JsonPropertyName 
( 
$str #
)# $
]$ %
public 

int 
HumidityMax 
{ 
get  
;  !
set" %
;% &
}' (
[ 
JsonPropertyName 
( 
$str 
) 
]  
public 

int 
Toggle 
{ 
get 
; 
set  
;  !
}" #
} Ë
*C:\tempProjNew\api\DTOs\Room\GetRoomDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Room 
{ 
public 

class 

GetRoomDto 
{ 
public 

GetRoomDto 
( 
) 
{ 
} 
public 

GetRoomDto 
( 
int 
id  
,  !
int" %
	office_id& /
,/ 0
string1 7
name8 <
,< =
bool> B$
physical_overlay_enabledC [
,[ \
double] c
desired_tempd p
,p q
bool 
window_toggle 
, 
int  #
req_rank$ ,
), -
{		 	
Id

 
=

 
id

 
;

 
	Office_id 
= 
	office_id !
;! "
Name 
= 
name 
; $
Physical_overlay_enabled $
=% &$
physical_overlay_enabled' ?
;? @
Desired_temp 
= 
desired_temp '
;' (
Window_toggle 
= 
window_toggle )
;) *
Req_rank 
= 
req_rank 
;  
} 	
public 
int 
Id 
{ 
get 
; 
set  
;  !
}" #
public 
int 
	Office_id 
{ 
get "
;" #
set$ '
;' (
}) *
public 
string 
Name 
{ 
get  
;  !
set" %
;% &
}' (
public 
bool $
Physical_overlay_enabled ,
{- .
get/ 2
;2 3
set4 7
;7 8
}9 :
public 
double 
Desired_temp "
{# $
get% (
;( )
set* -
;- .
}/ 0
public 
bool 
Window_toggle !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
int 
Req_rank 
{ 
get !
;! "
set# &
;& '
}( )
} 
} Ú
-C:\tempProjNew\api\DTOs\Room\UpdateRoomDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Room 
; 
public 
class 
UpdateRoomDto 
{ 
public 

UpdateRoomDto 
( 
int 
	office_id &
,& '
string( .
name/ 3
,3 4
bool5 9$
physical_overlay_enabled: R
,R S
doubleT Z
desired_temp[ g
,g h
bool 
window_toggle 
, 
int 
req_rank  (
)( )
{ 
	Office_id 
= 
	office_id 
; 
Name		 
=		 
name		 
;		 $
Physical_overlay_enabled

  
=

! "$
physical_overlay_enabled

# ;
;

; <
Desired_temp 
= 
desired_temp #
;# $
Window_toggle 
= 
window_toggle %
;% &
Req_rank 
= 
req_rank 
; 
} 
public 

int 
	Office_id 
{ 
get 
; 
set  #
;# $
}% &
public 

string 
Name 
{ 
get 
; 
set !
;! "
}# $
public 

bool $
Physical_overlay_enabled (
{) *
get+ .
;. /
set0 3
;3 4
}5 6
public 

double 
Desired_temp 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 

bool 
Window_toggle 
{ 
get  #
;# $
set% (
;( )
}* +
public 

int 
Req_rank 
{ 
get 
; 
set "
;" #
}$ %
} š
4C:\tempProjNew\api\DTOs\Room\UpdateTemperatureDto.cs
	namespace 	
api
 
. 
DTOs 
. 
Room 
{ 
public 

class  
UpdateTemperatureDto %
{ 
public  
UpdateTemperatureDto #
(# $
string$ *
name+ /
,/ 0
string1 7
office_name8 C
,C D
doubleE K
desired_tempL X
,X Y
boolZ ^
window_toggle_ l
)l m
{ 	
Name 
= 
name 
; 
Office_name 
= 
office_name %
;% &
Desired_temp		 
=		 
desired_temp		 '
;		' (
Window_toggle

 
=

 
window_toggle

 )
;

) *
} 	
public 
string 
Name 
{ 
get  
;  !
set" %
;% &
}' (
public 
string 
Office_name !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
double 
Desired_temp "
{# $
get% (
;( )
set* -
;- .
}/ 0
public 
bool 
Window_toggle !
{" #
get$ '
;' (
set) ,
;, -
}. /
} 
} Ñ	
8C:\tempProjNew\api\Filters\ValidateAccountIdAttribute.cs
	namespace 	
api
 
. 
Filters 
; 
public 
class &
ValidateAccountIdAttribute '
:( )!
ActionFilterAttribute* ?
{ 
public 

override 
void 
OnActionExecuting *
(* +"
ActionExecutingContext+ A
contextB I
)I J
{		 
var

 
	accountId

 
=

 
context

 
.

  
HttpContext

  +
.

+ ,
Items

, 1
[

1 2
$str

2 ;
]

; <
as

= ?
string

@ F
;

F G
if 

( 
string 
. 
IsNullOrEmpty  
(  !
	accountId! *
)* +
)+ ,
{ 	
throw 
new 

Exceptions  
.  !!
InvalidTokenException! 6
(6 7
)7 8
;8 9
} 	
base 
. 
OnActionExecuting 
( 
context &
)& '
;' (
} 
} Ú
+C:\tempProjNew\api\Filters\ValidateModel.cs
	namespace 	
api
 
. 
Filters 
; 
public 
class 
ValidateModel 
: !
ActionFilterAttribute 2
{ 
public		 

override		 
void		 
OnActionExecuting		 *
(		* +"
ActionExecutingContext		+ A
context		B I
)		I J
{

 
if 

( 
context 
. 

ModelState 
. 
IsValid &
)& '
return 
; 
var 
errorMessages 
= 
context #
.# $

ModelState$ .
. 
Values 
. 

SelectMany 
( 
i 
=> 
i 
. 
Errors %
.% &
Select& ,
(, -
e- .
=>/ 1
e2 3
.3 4
ErrorMessage4 @
)@ A
)A B
. 
	Aggregate 
( 
( 
i 
, 
j 
) 
=>  
i! "
+# $
$str% (
+) *
j+ ,
), -
;- .
context 
. 
Result 
= 
new 

JsonResult '
(' (
new( +
ResponseDto, 7
{ 	
MessageToClient 
= 
errorMessages +
} 	
)	 

{ 	

StatusCode 
= 
$num 
} 	
;	 

} 
} Û
,C:\tempProjNew\api\Helpers\RequestHandler.cs
	namespace 	
api
 
. 
Helpers 
{ 
public 

class 
RequestHandler 
{ 
private 
readonly 
IActionLogger &
_actionLogger' 4
;4 5
public

 
RequestHandler

 
(

 
IActionLogger

 +
actionLogger

, 8
)

8 9
{ 	
_actionLogger 
= 
actionLogger (
;( )
} 	
public 
ResponseDto 
HandleRequest (
(( )
Func) -
<- .
object. 4
?4 5
>5 6
action7 =
,= >
int? B
?B C
	accountIdD M
,M N
intO R
roomIdS Y
,Y Z
int[ ^
officeId_ g
,g h
stringi o
actionDescription	p 
)
 ‚
{ 	
try 
{ 
var 
result 
= 
action #
(# $
)$ %
;% &
if 
( 
	accountId 
!=  
null! %
)% &
{ 
_actionLogger !
.! "
	LogAction" +
(+ ,
	accountId, 5
,5 6
roomId6 <
,< =
officeId= E
,E F
actionDescriptionG X
)X Y
;Y Z
} 
return 
new 
ResponseDto &
{ 
MessageToClient #
=$ %
$str& D
,D E
ResponseData  
=! "
result# )
} 
; 
} 
catch 
( 
	Exception 
ex 
)  
{ 
return   
new   
ResponseDto   &
{!! 
MessageToClient"" #
=""$ %
ex""& (
.""( )
Message"") 0
,""0 1
ResponseData##  
=##! "
null### '
}$$ 
;$$ 
}%% 
}&& 	
}'' 
}(( ñ0
7C:\tempProjNew\api\Middleware\GlobalExceptionHandler.cs
	namespace 	
api
 
. 

Middleware 
{ 
public 

class "
GlobalExceptionHandler '
{		 
private

 
readonly

 
RequestDelegate

 (
_next

) .
;

. /
private 
readonly 
ILogger  
<  !"
GlobalExceptionHandler! 7
>7 8
_logger9 @
;@ A
public "
GlobalExceptionHandler %
(% &
ILogger& -
<- ."
GlobalExceptionHandler. D
>D E
loggerF L
,L M
RequestDelegateN ]
next^ b
)b c
{ 	
_logger 
= 
logger 
; 
_next 
= 
next 
; 
} 	
public 
async 
Task 
InvokeAsync %
(% &
HttpContext& 1
context2 9
)9 :
{ 	
try 
{ 
await 
_next 
( 
context #
)# $
;$ %
} 
catch 
( 
	Exception 
	exception &
)& '
{ 
await  
HandleExceptionAsync *
(* +
context+ 2
,2 3
	exception4 =
)= >
;> ?
} 
} 	
private 
async 
Task  
HandleExceptionAsync /
(/ 0
HttpContext0 ;
context< C
,C D
	ExceptionE N
	exceptionO X
)X Y
{   	
context!! 
.!! 
Response!! 
.!! 
ContentType!! (
=!!) *
$str!!+ =
;!!= >
_logger"" 
."" 
LogError"" 
("" 
	exception"" &
,""& '
$str""( k
,""k l
context""m t
.""t u
Request""u |
.""| }
Path	""} 
,
"" ‚
	exception
""ƒ Œ
.
""Œ 
Message
"" ”
)
""” •
;
""• –
context$$ 
.$$ 
Response$$ 
.$$ 

StatusCode$$ '
=$$( )
	exception$$* 3
switch$$4 :
{%% 
ValidationException&& #
=>&&$ &
StatusCodes&&' 2
.&&2 3
Status400BadRequest&&3 F
,&&F G 
KeyNotFoundException'' $
=>''% '
StatusCodes''( 3
.''3 4
Status404NotFound''4 E
,''E F#
AuthenticationException(( '
=>((( *
StatusCodes((+ 6
.((6 7!
Status401Unauthorized((7 L
,((L M'
UnauthorizedAccessException)) +
=>)), .
StatusCodes))/ :
.)): ;
Status403Forbidden)); M
,))M N

Exceptions** 
.** '
DatabaseConnectionException** 6
=>**7 9
StatusCodes**: E
.**E F'
Status503ServiceUnavailable**F a
,**a b

Exceptions++ 
.++ #
QueryExecutionException++ 2
=>++3 5
StatusCodes++6 A
.++A B(
Status500InternalServerError++B ^
,++^ _

Exceptions,, 
.,, *
LoggingQueryExecutionException,, 9
=>,,: <
StatusCodes,,= H
.,,H I(
Status500InternalServerError,,I e
,,,e f

Exceptions-- 
.-- '
InvalidAccountDataException-- 6
=>--7 9
StatusCodes--: E
.--E F
Status400BadRequest--F Y
,--Y Z

Exceptions.. 
... !
InvalidTokenException.. 0
=>..1 3
StatusCodes..4 ?
...? @!
Status401Unauthorized..@ U
,..U V

Exceptions// 
.// $
PasswordHashingException// 3
=>//4 6
StatusCodes//7 B
.//B C(
Status500InternalServerError//C _
,//_ `
_00 
=>00 
StatusCodes00  
.00  !(
Status500InternalServerError00! =
}11 
;11 
var33 
response33 
=33 
new33 
ResponseDto33 *
{44 
MessageToClient55 
=55  !
GetClientMessage55" 2
(552 3
	exception553 <
)55< =
}66 
;66 
await88 
context88 
.88 
Response88 "
.88" #
WriteAsJsonAsync88# 3
(883 4
response884 <
)88< =
;88= >
}99 	
private;; 
static;; 
string;; 
GetClientMessage;; .
(;;. /
	Exception;;/ 8
	exception;;9 B
);;B C
{<< 	
return== 
	exception== 
switch== #
{>> 
ValidationException?? #
=>??$ &
$str??' T
,??T U 
KeyNotFoundException@@ $
=>@@% '
$str@@( O
,@@O P#
AuthenticationExceptionAA '
=>AA( *
$strAA+ C
,AAC D'
UnauthorizedAccessExceptionBB +
=>BB, .
$strBB/ ?
,BB? @

ExceptionsCC 
.CC '
DatabaseConnectionExceptionCC 6
=>CC7 9
$strCC: r
,CCr s

ExceptionsDD 
.DD #
QueryExecutionExceptionDD 2
=>DD3 5
$strDD6 c
,DDc d

ExceptionsEE 
.EE *
LoggingQueryExecutionExceptionEE 9
=>EE: <
$strEE= h
,EEh i

ExceptionsFF 
.FF '
InvalidAccountDataExceptionFF 6
=>FF7 9
$strFF: Z
,FFZ [

ExceptionsGG 
.GG !
InvalidTokenExceptionGG 0
=>GG1 3
$strGG4 M
,GGM N

ExceptionsHH 
.HH $
PasswordHashingExceptionHH 3
=>HH4 6
$strHH7 i
,HHi j
_II 
=>II 
$strII Z
}JJ 
;JJ 
}KK 	
}LL 
}MM Ø
.C:\tempProjNew\api\Middleware\JwtMiddleware.cs
	namespace 	
api
 
. 

Middleware 
; 
public		 
class		 
JwtMiddleware		 
{

 
private 
readonly 
RequestDelegate $
_next% *
;* +
private 
readonly 
JwtSettings  
_jwtSettings! -
;- .
public 

JwtMiddleware 
( 
RequestDelegate (
next) -
,- .
IOptions/ 7
<7 8
JwtSettings8 C
>C D
jwtSettingsE P
)P Q
{ 
_next 
= 
next 
; 
_jwtSettings 
= 
jwtSettings "
." #
Value# (
;( )
} 
public 

async 
Task 
Invoke 
( 
HttpContext (
context) 0
)0 1
{ 
var 
token 
= 
context 
. 
Request #
.# $
Headers$ +
[+ ,
$str, ;
]; <
.< =
FirstOrDefault= K
(K L
)L M
?M N
.N O
SplitO T
(T U
$strU X
)X Y
.Y Z
LastZ ^
(^ _
)_ `
;` a
if 

( 
token 
!= 
null 
) "
AttachAccountToContext "
(" #
context# *
,* +
token, 1
)1 2
;2 3
await 
_next 
( 
context 
) 
; 
} 
private 
void "
AttachAccountToContext '
(' (
HttpContext( 3
context4 ;
,; <
string= C
tokenD I
)I J
{ 
try   
{!! 	
var"" 
tokenHandler"" 
="" 
new"" "#
JwtSecurityTokenHandler""# :
("": ;
)""; <
;""< =
var## 
key## 
=## 
Encoding## 
.## 
UTF8## #
.### $
GetBytes##$ ,
(##, -
_jwtSettings##- 9
.##9 :
Key##: =
)##= >
;##> ?
tokenHandler$$ 
.$$ 
ValidateToken$$ &
($$& '
token$$' ,
,$$, -
new$$. 1%
TokenValidationParameters$$2 K
{%% $
ValidateIssuerSigningKey&& (
=&&) *
true&&+ /
,&&/ 0
IssuerSigningKey''  
=''! "
new''# & 
SymmetricSecurityKey''' ;
(''; <
key''< ?
)''? @
,''@ A
ValidateIssuer(( 
=((  
false((! &
,((& '
ValidateAudience))  
=))! "
false))# (
,))( )
	ClockSkew++ 
=++ 
TimeSpan++ $
.++$ %
Zero++% )
},, 
,,, 
out,, 
SecurityToken,,  
validatedToken,,! /
),,/ 0
;,,0 1
var.. 
jwtToken.. 
=.. 
(.. 
JwtSecurityToken.. ,
).., -
validatedToken..- ;
;..; <
var// 
	accountId// 
=// 
jwtToken// $
.//$ %
Claims//% +
.//+ ,
First//, 1
(//1 2
x//2 3
=>//4 6
x//7 8
.//8 9
Type//9 =
==//> @
$str//A E
)//E F
.//F G
Value//G L
;//L M
context22 
.22 
Items22 
[22 
$str22 #
]22# $
=22% &
	accountId22' 0
;220 1
}33 	
catch44 
{55 	
}88 	
}99 
}:: Š$
4C:\tempProjNew\api\Middleware\WebSocketMiddleware.cs
	namespace 	
api
 
. 

Middleware 
; 
public 
class 
WebSocketMiddleware  
{		 
private

 
readonly

 
RequestDelegate

 $
_next

% *
;

* +
private 
readonly 
ILogger 
< 
WebSocketMiddleware 0
>0 1
_logger2 9
;9 :
private 
readonly 
MqttService  
_mqttService! -
;- .
public 

WebSocketMiddleware 
( 
RequestDelegate .
next/ 3
,3 4
ILogger5 <
<< =
WebSocketMiddleware= P
>P Q
loggerR X
,X Y
MqttServiceZ e
mqttServicef q
)q r
{ 
_next 
= 
next 
; 
_logger 
= 
logger 
; 
_mqttService 
= 
mqttService "
;" #
} 
public 

async 
Task 
InvokeAsync !
(! "
HttpContext" -
context. 5
)5 6
{ 
if 

( 
context 
. 

WebSockets 
. 
IsWebSocketRequest 1
)1 2
{ 	
var 
	webSocket 
= 
await !
context" )
.) *

WebSockets* 4
.4 5 
AcceptWebSocketAsync5 I
(I J
)J K
;K L
await  
HandleWebSocketAsync &
(& '
context' .
,. /
	webSocket0 9
)9 :
;: ;
} 	
else 
{ 	
await 
_next 
( 
context 
)  
;  !
} 	
}   
private"" 
async"" 
Task""  
HandleWebSocketAsync"" +
(""+ ,
HttpContext"", 7
context""8 ?
,""? @
	WebSocket""A J
	webSocket""K T
)""T U
{## 
var$$ 
buffer$$ 
=$$ 
new$$ 
byte$$ 
[$$ 
$num$$ "
*$$# $
$num$$% &
]$$& '
;$$' ("
WebSocketReceiveResult%% 
result%% %
=%%& '
await%%( -
	webSocket%%. 7
.%%7 8
ReceiveAsync%%8 D
(%%D E
new%%E H
ArraySegment%%I U
<%%U V
byte%%V Z
>%%Z [
(%%[ \
buffer%%\ b
)%%b c
,%%c d
CancellationToken%%e v
.%%v w
None%%w {
)%%{ |
;%%| }
while'' 
('' 
!'' 
result'' 
.'' 
CloseStatus'' "
.''" #
HasValue''# +
)''+ ,
{(( 	
var)) 
message)) 
=)) 
Encoding)) "
.))" #
UTF8))# '
.))' (
	GetString))( 1
())1 2
buffer))2 8
,))8 9
$num)): ;
,)); <
result))= C
.))C D
Count))D I
)))I J
;))J K
_logger** 
.** 
LogInformation** "
(**" #
$"**# %
$str**% A
{**A B
message**B I
}**I J
"**J K
)**K L
;**L M
await,, 
_mqttService,, 
.,, 
PublishAsync,, +
(,,+ ,
$str,,, 8
,,,8 9
message,,: A
),,A B
;,,B C
result.. 
=.. 
await.. 
	webSocket.. $
...$ %
ReceiveAsync..% 1
(..1 2
new..2 5
ArraySegment..6 B
<..B C
byte..C G
>..G H
(..H I
buffer..I O
)..O P
,..P Q
CancellationToken..R c
...c d
None..d h
)..h i
;..i j
}// 	
await11 
	webSocket11 
.11 

CloseAsync11 "
(11" #
result11# )
.11) *
CloseStatus11* 5
.115 6
Value116 ;
,11; <
result11= C
.11C D"
CloseStatusDescription11D Z
,11Z [
CancellationToken11\ m
.11m n
None11n r
)11r s
;11s t
}22 
}33 ‚`
C:\tempProjNew\api\Program.cs
var 
builder 
= 
WebApplication 
. 
CreateBuilder *
(* +
args+ /
)/ 0
;0 1
builder 
. 
Services 
. 
AddControllers 
(  
)  !
;! "
builder 
. 
Services 
. 
AddSingleton 
< $
INpgsqlConnectionFactory 6
>6 7
(7 8
sp8 :
=>; =
new> A#
NpgsqlConnectionFactoryB Y
(Y Z
	UtilitiesZ c
.c d.
!ProperlyFormattedConnectionString	d …
)
… †
)
† ‡
;
‡ ˆ
builder 
. 
Services 
. 
AddSingleton 
< 
	IDatabase '
,' (
DapperDatabase) 7
>7 8
(8 9
)9 :
;: ;
builder 
. 
Services 
. 
AddSingleton 
< 
ICrudHandler *
,* +
CrudHandler, 7
>7 8
(8 9
)9 :
;: ;
builder 
. 
Services 
. 
AddSingleton 
< 
ICrudService *
,* +
CrudService, 7
>7 8
(8 9
)9 :
;: ;
builder 
. 
Services 
. 
AddSingleton 
< 
IHashService *
,* +
HashService, 7
>7 8
(8 9
)9 :
;: ;
builder 
. 
Services 
. 
AddSingleton 
< 
IActionLogger +
,+ ,
ActionLogger- 9
>9 :
(: ;
); <
;< =
builder 
. 
Services 
. 
AddSingleton 
< 
MqttService )
>) *
(* +
)+ ,
;, -
builder 
. 
Services 
. 
AddSingleton 
< 
WebSocketServer -
>- .
(. /
sp/ 1
=>2 4
new5 8
WebSocketServer9 H
(H I
$strI \
)\ ]
)] ^
;^ _
builder 
. 
Services 
. 
AddSingleton 
< 
RequestHandler ,
>, -
(- .
). /
;/ 0
builder"" 
."" 
Services"" 
."" 
	Configure"" 
<"" 
JwtSettings"" &
>""& '
(""' (
builder""( /
.""/ 0
Configuration""0 =
.""= >

GetSection""> H
(""H I
$str""I N
)""N O
)""O P
;""P Q
builder%% 
.%% 
Services%% 
.%% 
AddSingleton%% 
<%% 
ITokenService%% +
,%%+ ,
TokenService%%- 9
>%%9 :
(%%: ;
sp%%; =
=>%%> @
{&& 
var'' 
jwtSettings'' 
='' 
sp'' 
.'' 
GetRequiredService'' +
<''+ ,
IOptions'', 4
<''4 5
JwtSettings''5 @
>''@ A
>''A B
(''B C
)''C D
.''D E
Value''E J
;''J K
return(( 

new(( 
TokenService(( 
((( 
jwtSettings(( '
)((' (
;((( )
})) 
))) 
;)) 
builder,, 
.,, 
Services,, 
.,, 
	Configure,, 
<,, 
MqttSettings,, '
>,,' (
(,,( )
builder,,) 0
.,,0 1
Configuration,,1 >
.,,> ?

GetSection,,? I
(,,I J
$str,,J X
),,X Y
),,Y Z
;,,Z [
builder// 
.// 
Services// 
.// #
AddEndpointsApiExplorer// (
(//( )
)//) *
;//* +
builder00 
.00 
Services00 
.00 
AddSwaggerGen00 
(00 
)00  
;00  !
if22 
(22 
builder22 
.22 
Environment22 
.22 
IsDevelopment22 %
(22% &
)22& '
)22' (
{33 
builder44 
.44 
Services44 
.44 
AddNpgsqlDataSource44 (
(44( )
	Utilities44) 2
.442 3-
!ProperlyFormattedConnectionString443 T
,44T U
dataSourceBuilder55 
=>55 
dataSourceBuilder55 .
.55. /"
EnableParameterLogging55/ E
(55E F
)55F G
)55G H
;55H I
}66 
if88 
(88 
builder88 
.88 
Environment88 
.88 
IsProduction88 $
(88$ %
)88% &
)88& '
{99 
builder:: 
.:: 
Services:: 
.:: 
AddNpgsqlDataSource:: (
(::( )
	Utilities::) 2
.::2 3-
!ProperlyFormattedConnectionString::3 T
)::T U
;::U V
};; 
builder>> 
.>> 
Services>> 
.>> 
AddAuthentication>> "
(>>" #
options>># *
=>>>+ -
{?? 
options@@ 
.@@ %
DefaultAuthenticateScheme@@ %
=@@& '
JwtBearerDefaults@@( 9
.@@9 : 
AuthenticationScheme@@: N
;@@N O
optionsAA 
.AA "
DefaultChallengeSchemeAA "
=AA# $
JwtBearerDefaultsAA% 6
.AA6 7 
AuthenticationSchemeAA7 K
;AAK L
}BB 
)BB 
.BB 
AddJwtBearerBB 
(BB 
optionsBB 
=>BB 
{CC 
varDD 
	jwtConfigDD 
=DD 
builderDD 
.DD 
ConfigurationDD )
.DD) *

GetSectionDD* 4
(DD4 5
$strDD5 :
)DD: ;
;DD; <
varEE 
keyEE 
=EE 
EncodingEE 
.EE 
UTF8EE 
.EE 
GetBytesEE $
(EE$ %
	jwtConfigEE% .
.EE. /
GetValueEE/ 7
<EE7 8
stringEE8 >
>EE> ?
(EE? @
$strEE@ E
)EEE F
??FF% '
throwFF( -
newFF. 1"
NullReferenceExceptionFF2 H
(FFH I
$strFFI a
)FFa b
)FFb c
;FFc d
optionsGG 
.GG 
	SaveTokenGG 
=GG 
trueGG 
;GG 
optionsHH 
.HH %
TokenValidationParametersHH %
=HH& '
newHH( +%
TokenValidationParametersHH, E
{II 
ValidateIssuerJJ 
=JJ 
falseJJ 
,JJ 
ValidateAudienceKK 
=KK 
falseKK  
,KK  !
ValidateLifetimeLL 
=LL 
trueLL 
,LL  $
ValidateIssuerSigningKeyMM  
=MM! "
trueMM# '
,MM' (
IssuerSigningKeyNN 
=NN 
newNN  
SymmetricSecurityKeyNN 3
(NN3 4
keyNN4 7
)NN7 8
}OO 
;OO 
}PP 
)PP 
;PP 
builderSS 
.SS 
ServicesSS 
.SS 
AddSwaggerGenSS 
(SS 
cSS  
=>SS! #
{TT 
cUU 
.UU !
AddSecurityDefinitionUU 
(UU 
JwtBearerDefaultsUU -
.UU- . 
AuthenticationSchemeUU. B
,UUB C
newUUD G!
OpenApiSecuritySchemeUUH ]
{VV 
NameWW 
=WW 
$strWW 
,WW 
TypeXX 
=XX 
SecuritySchemeTypeXX !
.XX! "
HttpXX" &
,XX& '
SchemeYY 
=YY 
JwtBearerDefaultsYY "
.YY" # 
AuthenticationSchemeYY# 7
,YY7 8
BearerFormatZZ 
=ZZ 
$strZZ 
,ZZ 
In[[ 

=[[ 
ParameterLocation[[ 
.[[ 
Header[[ %
,[[% &
Description\\ 
=\\ 
$str\\ I
}]] 
)]] 
;]] 
c__ 
.__ "
AddSecurityRequirement__ 
(__ 
new__  &
OpenApiSecurityRequirement__! ;
{`` 
{aa 	
newbb !
OpenApiSecuritySchemebb %
{cc 
	Referencedd 
=dd 
newdd 
OpenApiReferencedd  0
{ee 
Typeff 
=ff 
ReferenceTypeff (
.ff( )
SecuritySchemeff) 7
,ff7 8
Idgg 
=gg 
JwtBearerDefaultsgg *
.gg* + 
AuthenticationSchemegg+ ?
}hh 
}ii 
,ii 
newjj 
[jj 
]jj 
{jj 
$strjj 
}jj 
}kk 	
}ll 
)ll 
;ll 
}mm 
)mm 
;mm 
builderoo 
.oo 
Servicesoo 
.oo 

AddLoggingoo 
(oo 
)oo 
;oo 
varqq 
appqq 
=qq 	
builderqq
 
.qq 
Buildqq 
(qq 
)qq 
;qq 
iftt 
(tt 
apptt 
.tt 
Environmenttt 
.tt 
IsDevelopmenttt !
(tt! "
)tt" #
)tt# $
{uu 
appvv 
.vv 

UseSwaggervv 
(vv 
)vv 
;vv 
appww 
.ww 
UseSwaggerUIww 
(ww 
)ww 
;ww 
}xx 
app{{ 
.{{ 
UseMiddleware{{ 
<{{ "
GlobalExceptionHandler{{ (
>{{( )
({{) *
){{* +
;{{+ ,
app|| 
.|| 
UseMiddleware|| 
<|| 
JwtMiddleware|| 
>||  
(||  !
)||! "
;||" #
app~~ 
.~~ 
UseHttpsRedirection~~ 
(~~ 
)~~ 
;~~ 
app 
. 
UseCors 
( 
options 
=> 
{€€ 
options
 
.
  
SetIsOriginAllowed
 
(
 
origin
 %
=>
& (
true
) -
)
- .
.
‚‚ 	
AllowAnyHeader
‚‚	 
(
‚‚ 
)
‚‚ 
.
ƒƒ 	
AllowAnyMethod
ƒƒ	 
(
ƒƒ 
)
ƒƒ 
.
„„ 	
AllowCredentials
„„	 
(
„„ 
)
„„ 
;
„„ 
}…… 
)
…… 
;
…… 
app‡‡ 
.
‡‡ 
UseAuthentication
‡‡ 
(
‡‡ 
)
‡‡ 
;
‡‡ 
appˆˆ 
.
ˆˆ 
UseAuthorization
ˆˆ 
(
ˆˆ 
)
ˆˆ 
;
ˆˆ 
appŠŠ 
.
ŠŠ 
UseWebSockets
ŠŠ 
(
ŠŠ 
)
ŠŠ 
;
ŠŠ 
app 
.
 
MapControllers
 
(
 
)
 
;
 
var 
mqttService
 
=
 
app
 
.
 
Services
 
.
  
GetRequiredService
 1
<
1 2
MqttService
2 =
>
= >
(
> ?
)
? @
;
@ A
await‘‘ 
mqttService
‘‘ 
.
‘‘ 

StartAsync
‘‘ 
(
‘‘ 
)
‘‘ 
;
‘‘ 
Console““ 
.
““ 
	WriteLine
““ 
(
““ 
$str
““ A
)
““A B
;
““B C
app•• 
.
•• 
Run
•• 
(
•• 
)
•• 	
;
••	 
”t
*C:\tempProjNew\api\Services\MqttService.cs
	namespace 	
api
 
. 
Services 
{ 
public 

class 
MqttService 
{ 
private 
readonly 
IMqttClient $
_mqttClient% 0
;0 1
private 
readonly 
ILogger  
<  !
MqttService! ,
>, -
_logger. 5
;5 6
private 
readonly 
MqttSettings %
_mqttSettings& 3
;3 4
private 
readonly 
WebSocketServer (
_webSocketServer) 9
;9 :
private 
readonly 
ICrudService %
_crudService& 2
;2 3
public 
MqttService 
( 
ILogger "
<" #
MqttService# .
>. /
logger0 6
,6 7
IConfiguration8 F
configurationG T
,T U
WebSocketServerV e
webSocketServerf u
,u v
ICrudService	w ƒ
crudService
„ 
)
 
{ 	
_logger 
= 
logger 
; 
var 
factory 
= 
new 
MqttFactory )
() *
)* +
;+ ,
_mqttClient 
= 
factory !
.! "
CreateMqttClient" 2
(2 3
)3 4
;4 5
_mqttSettings 
= 
configuration )
.) *

GetSection* 4
(4 5
$str5 C
)C D
.D E
GetE H
<H I
MqttSettingsI U
>U V
(V W
)W X
;X Y
_mqttSettings 
. 
Username "
=# $
Environment% 0
.0 1"
GetEnvironmentVariable1 G
(G H
$strH W
)W X
;X Y
_webSocketServer   
=   
webSocketServer   .
;  . /
_crudService!! 
=!! 
crudService!! &
;!!& '
}"" 	
public$$ 
async$$ 
Task$$ 

StartAsync$$ $
($$$ %
)$$% &
{%% 	
var'' 
clientId'' 
='' 
$"'' 
{'' 
_mqttSettings'' +
.''+ ,
ClientId'', 4
}''4 5
$str''5 6
{''6 7
Guid''7 ;
.''; <
NewGuid''< C
(''C D
)''D E
}''E F
"''F G
;''G H
var)) 
options)) 
=)) 
new)) $
MqttClientOptionsBuilder)) 6
())6 7
)))7 8
.** 
WithClientId** 
(** 
clientId** &
)**& '
.++ 
WithTcpServer++ 
(++ 
_mqttSettings++ ,
.++, -
	BrokerUrl++- 6
,++6 7
_mqttSettings++8 E
.++E F
Port++F J
)++J K
.,, 
WithCredentials,,  
(,,  !
_mqttSettings,,! .
.,,. /
Username,,/ 7
,,,7 8
_mqttSettings,,9 F
.,,F G
Password,,G O
),,O P
.-- 
Build-- 
(-- 
)-- 
;-- 
_mqttClient// 
.// 
UseConnectedHandler// +
(//+ ,
async//, 1
e//2 3
=>//4 6
{00 
_logger11 
.11 
LogInformation11 &
(11& '
$str11' A
)11A B
;11B C
await22 
_mqttClient22 !
.22! "
SubscribeAsync22" 0
(220 1
new221 4"
MqttTopicFilterBuilder225 K
(22K L
)22L M
.22M N
	WithTopic22N W
(22W X
$str22X `
)22` a
.22a b
Build22b g
(22g h
)22h i
)22i j
;22j k
_logger33 
.33 
LogInformation33 &
(33& '
$str33' C
)33C D
;33D E
}44 
)44 
;44 
_mqttClient66 
.66 "
UseDisconnectedHandler66 .
(66. /
e66/ 0
=>661 3
{77 
_logger88 
.88 
LogInformation88 &
(88& '
$str88' F
)88F G
;88G H
}99 
)99 
;99 
_mqttClient;; 
.;; 0
$UseApplicationMessageReceivedHandler;; <
(;;< =
e;;= >
=>;;? A
{<< 
var== 
message== 
=== 
Encoding== &
.==& '
UTF8==' +
.==+ ,
	GetString==, 5
(==5 6
e==6 7
.==7 8
ApplicationMessage==8 J
.==J K
Payload==K R
)==R S
;==S T
_logger>> 
.>> 
LogInformation>> &
(>>& '
$">>' )
$str>>) ;
{>>; <
message>>< C
}>>C D
">>D E
)>>E F
;>>F G
ProcessMqttMessage?? "
(??" #
e??# $
.??$ %
ApplicationMessage??% 7
.??7 8
Topic??8 =
,??= >
message??? F
)??F G
;??G H
}@@ 
)@@ 
;@@ 
awaitBB 
_mqttClientBB 
.BB 
ConnectAsyncBB *
(BB* +
optionsBB+ 2
)BB2 3
;BB3 4
}CC 	
privateEE 
voidEE 
ProcessMqttMessageEE '
(EE' (
stringEE( .
topicEE/ 4
,EE4 5
stringEE6 <
messageEE= D
)EED E
{FF 	
ConsoleHH 
.HH 
	WriteLineHH 
(HH 
$"HH  
$strHH  9
{HH9 :
messageHH: A
}HHA B
"HHB C
)HHC D
;HHD E
varKK 

topicPartsKK 
=KK 
topicKK "
.KK" #
SplitKK# (
(KK( )
$charKK) ,
)KK, -
;KK- .
ifLL 
(LL 

topicPartsLL 
.LL 
LengthLL !
<LL" #
$numLL$ %
||LL& (

topicPartsLL) 3
[LL3 4
$numLL4 5
]LL5 6
!=LL7 9
$strLL: @
)LL@ A
{MM 
ConsoleNN 
.NN 
	WriteLineNN !
(NN! "
$strNN" c
)NNc d
;NNd e
returnOO 
;OO 
}PP 
varRR 

officeNameRR 
=RR 

topicPartsRR '
[RR' (
$numRR( )
]RR) *
;RR* +
varSS 
roomNameSS 
=SS 

topicPartsSS %
[SS% &
$numSS& '
]SS' (
;SS( )
varTT 
fullRoomNameTT 
=TT 
$"TT !
{TT! "

officeNameTT" ,
}TT, -
$strTT- .
{TT. /
roomNameTT/ 7
}TT7 8
"TT8 9
;TT9 :
tryWW 
{XX 
varYY 
deviceMessageYY !
=YY" #
JsonSerializerYY$ 2
.YY2 3
DeserializeYY3 >
<YY> ?
DeviceMessageDtoYY? O
>YYO P
(YYP Q
messageYYQ X
)YYX Y
;YYY Z
ifZZ 
(ZZ 
deviceMessageZZ !
!=ZZ" $
nullZZ% )
)ZZ) *
{[[ 
var\\ 

updateData\\ "
=\\# $
new\\% ( 
UpdateTemperatureDto\\) =
(\\= >
name]] 
:]] 
roomName]] &
,]]& '
office_name^^ #
:^^# $

officeName^^% /
,^^/ 0
desired_temp__ $
:__$ %
deviceMessage__& 3
.__3 4
TargetTemperature__4 E
,__E F
window_toggle`` %
:``% &
deviceMessage``' 4
.``4 5
Toggle``5 ;
==``< >
$num``? @
)aa 
;aa 
SaveTemperatureDatadd '
(dd' (

updateDatadd( 2
)dd2 3
;dd3 4
_webSocketServergg $
.gg$ %
	Broadcastgg% .
(gg. /
fullRoomNamegg/ ;
,gg; <
messagegg= D
)ggD E
;ggE F
}hh 
}ii 
catchjj 
(jj 
	Exceptionjj 
exjj 
)jj  
{kk 
_loggerll 
.ll 
LogErrorll  
(ll  !
$"ll! #
$strll# B
{llB C
exllC E
.llE F
MessagellF M
}llM N
"llN O
)llO P
;llP Q
}mm 
}nn 	
privatepp 
voidpp 
SaveTemperatureDatapp (
(pp( ) 
UpdateTemperatureDtopp) =

updateDatapp> H
)ppH I
{qq 	
tryrr 
{ss 
vartt 
	officeDtott 
=tt 
_crudServicett  ,
.tt, -%
GetSingleItemByParameterstt- F
<ttF G
GetOfficeDtottG S
>ttS T
(ttT U
$strttU ]
,tt] ^
newuu 

Dictionaryuu "
<uu" #
stringuu# )
,uu) *
objectuu+ 1
>uu1 2
{uu3 4
{uu5 6
$struu7 =
,uu= >

updateDatauu? I
.uuI J
Office_nameuuJ U
}uuV W
}uuX Y
)uuY Z
;uuZ [
ifww 
(ww 
	officeDtoww 
==ww  
nullww! %
)ww% &
{xx 
throwyy 
newyy  
KeyNotFoundExceptionyy 2
(yy2 3
$"yy3 5
$stryy5 G
{yyG H

updateDatayyH R
.yyR S
Office_nameyyS ^
}yy^ _
$stryy_ k
"yyk l
)yyl m
;yym n
}zz 
var|| 
officeId|| 
=|| 
	officeDto|| (
.||( )
Id||) +
;||+ ,
var~~ 
updateResult~~  
=~~! "
_crudService~~# /
.~~/ 0

UpdateItem~~0 :
(~~: ;
$str~~; A
,~~A B
new 

Dictionary "
<" #
string# )
,) *
object+ 1
>1 2
{
€€ 
{
 
$str
  
,
  !

updateData
" ,
.
, -
Name
- 1
}
2 3
,
3 4
{
‚‚ 
$str
‚‚ %
,
‚‚% &
officeId
‚‚' /
}
‚‚0 1
}
ƒƒ 
,
ƒƒ 
new
„„ 

Dictionary
„„ "
<
„„" #
string
„„# )
,
„„) *
object
„„+ 1
>
„„1 2
{
…… 
{
†† 
$str
†† (
,
††( )

updateData
††* 4
.
††4 5
Desired_temp
††5 A
}
††B C
,
††C D
{
‡‡ 
$str
‡‡ )
,
‡‡) *

updateData
‡‡+ 5
.
‡‡5 6
Window_toggle
‡‡6 C
}
‡‡D E
}
ˆˆ 
)
ˆˆ 
;
ˆˆ 
if
ŠŠ 
(
ŠŠ 
!
ŠŠ 
updateResult
ŠŠ !
)
ŠŠ! "
{
‹‹ 
throw
ŒŒ 
new
ŒŒ 
	Exception
ŒŒ '
(
ŒŒ' (
$str
ŒŒ( I
)
ŒŒI J
;
ŒŒJ K
}
 
Console
 
.
 
	WriteLine
 !
(
! "
$"
" $
$str
$ B
{
B C

updateData
C M
.
M N
Name
N R
}
R S
"
S T
)
T U
;
U V
}
 
catch
‘‘ 
(
‘‘ 
	Exception
‘‘ 
ex
‘‘ 
)
‘‘  
{
’’ 
_logger
““ 
.
““ 
LogError
““  
(
““  !
$"
““! #
$str
““# B
{
““B C
ex
““C E
.
““E F
Message
““F M
}
““M N
"
““N O
)
““O P
;
““P Q
}
”” 
}
•• 	
public
—— 
async
—— 
Task
—— 
PublishAsync
—— &
(
——& '
string
——' -
topic
——. 3
,
——3 4
string
——5 ;
payload
——< C
)
——C D
{
˜˜ 	
var
™™ 
message
™™ 
=
™™ 
new
™™ +
MqttApplicationMessageBuilder
™™ ;
(
™™; <
)
™™< =
.
šš 
	WithTopic
šš 
(
šš 
topic
šš  
)
šš  !
.
›› 
WithPayload
›› 
(
›› 
payload
›› $
)
››$ %
.
œœ 
Build
œœ 
(
œœ 
)
œœ 
;
œœ 
await
žž 
_mqttClient
žž 
.
žž 
PublishAsync
žž *
(
žž* +
message
žž+ 2
)
žž2 3
;
žž3 4
_logger
ŸŸ 
.
ŸŸ 
LogInformation
ŸŸ "
(
ŸŸ" #
$"
ŸŸ# %
$str
ŸŸ% @
{
ŸŸ@ A
topic
ŸŸA F
}
ŸŸF G
$str
ŸŸG I
{
ŸŸI J
payload
ŸŸJ Q
}
ŸŸQ R
"
ŸŸR S
)
ŸŸS T
;
ŸŸT U
}
   	
public
¢¢ 
async
¢¢ 
Task
¢¢ 
SubscribeAsync
¢¢ (
(
¢¢( )
string
¢¢) /
topic
¢¢0 5
)
¢¢5 6
{
££ 	
await
¤¤ 
_mqttClient
¤¤ 
.
¤¤ 
SubscribeAsync
¤¤ ,
(
¤¤, -
new
¤¤- 0$
MqttTopicFilterBuilder
¤¤1 G
(
¤¤G H
)
¤¤H I
.
¤¤I J
	WithTopic
¤¤J S
(
¤¤S T
topic
¤¤T Y
)
¤¤Y Z
.
¤¤Z [
Build
¤¤[ `
(
¤¤` a
)
¤¤a b
)
¤¤b c
;
¤¤c d
_logger
¥¥ 
.
¥¥ 
LogInformation
¥¥ "
(
¥¥" #
$"
¥¥# %
$str
¥¥% 9
{
¥¥9 :
topic
¥¥: ?
}
¥¥? @
"
¥¥@ A
)
¥¥A B
;
¥¥B C
}
¦¦ 	
public
¨¨ 
async
¨¨ 
Task
¨¨ 
UnsubscribeAsync
¨¨ *
(
¨¨* +
string
¨¨+ 1
topic
¨¨2 7
)
¨¨7 8
{
©© 	
await
ªª 
_mqttClient
ªª 
.
ªª 
UnsubscribeAsync
ªª .
(
ªª. /
topic
ªª/ 4
)
ªª4 5
;
ªª5 6
_logger
«« 
.
«« 
LogInformation
«« "
(
««" #
$"
««# %
$str
««% =
{
««= >
topic
««> C
}
««C D
"
««D E
)
««E F
;
««F G
}
¬¬ 	
}
­­ 
}®® óU
0C:\tempProjNew\api\Websockets\WebSocketServer.cs
	namespace 	
api
 
. 

Websockets 
{ 
public 

class 
WebSocketServer  
{ 
private 
readonly 

Dictionary #
<# $
string$ *
,* +
List, 0
<0 1 
IWebSocketConnection1 E
>E F
>F G
_roomConnectionsH X
;X Y
public

 
WebSocketServer

 
(

 
string

 %
url

& )
)

) *
{ 	
var 
server 
= 
new 
Fleck "
." #
WebSocketServer# 2
(2 3
url3 6
)6 7
;7 8
_roomConnections 
= 
new "

Dictionary# -
<- .
string. 4
,4 5
List6 :
<: ; 
IWebSocketConnection; O
>O P
>P Q
(Q R
)R S
;S T
FleckLog 
. 
Level 
= 
LogLevel %
.% &
Info& *
;* +
server 
. 
Start 
( 
socket 
=>  "
{ 
socket 
. 
OnOpen 
= 
(  !
)! "
=># %
{ 
Console 
. 
	WriteLine %
(% &
$str& -
)- .
;. /
} 
; 
socket 
. 
OnClose 
=  
(! "
)" #
=>$ &
{ 
Console 
. 
	WriteLine %
(% &
$str& .
). /
;/ 0
RemoveConnection $
($ %
socket% +
)+ ,
;, -
} 
; 
socket 
. 
	OnMessage  
=! "
message# *
=>+ -
{ 
Console 
. 
	WriteLine %
(% &
$"& (
$str( :
{: ;
message; B
}B C
"C D
)D E
;E F
HandleMessage !
(! "
socket" (
,( )
message* 1
)1 2
;2 3
}   
;   
}!! 
)!! 
;!! 
}"" 	
private$$ 
void$$ 
HandleMessage$$ "
($$" # 
IWebSocketConnection$$# 7
socket$$8 >
,$$> ?
string$$@ F
message$$G N
)$$N O
{%% 	
var&& 
parts&& 
=&& 
message&& 
.&&  
Split&&  %
(&&% &
$char&&& )
)&&) *
;&&* +
if'' 
('' 
parts'' 
.'' 
Length'' 
<'' 
$num''  
)''  !
{(( 
socket)) 
.)) 
Send)) 
()) 
$str	)) £
)
))£ ¤
;
))¤ ¥
return** 
;** 
}++ 
var-- 
command-- 
=-- 
parts-- 
[--  
$num--  !
]--! "
;--" #
var.. 
roomName.. 
=.. 
parts..  
[..  !
$num..! "
].." #
;..# $
if00 
(00 
command00 
==00 
$str00 !
)00! "
{11 
JoinRoom22 
(22 
socket22 
,22  
roomName22! )
)22) *
;22* +
}33 
else44 
if44 
(44 
command44 
==44 
$str44  )
&&44* ,
parts44- 2
.442 3
Length443 9
>=44: <
$num44= >
)44> ?
{55 
var66 
userMessage66 
=66  !
string66" (
.66( )
Join66) -
(66- .
$char66. 1
,661 2
parts663 8
.668 9
Skip669 =
(66= >
$num66> ?
)66? @
)66@ A
;66A B
SendMessageToRoom77 !
(77! "
roomName77" *
,77* +
userMessage77, 7
,777 8
socket779 ?
)77? @
;77@ A
}88 
else99 
if99 
(99 
command99 
==99 
$str99  '
)99' (
{:: 
	LeaveRoom;; 
(;; 
socket;;  
,;;  !
roomName;;" *
);;* +
;;;+ ,
}<< 
else== 
{>> 
socket?? 
.?? 
Send?? 
(?? 
$str	?? œ
)
??œ 
;
?? ž
}@@ 
}AA 	
privateCC 
voidCC 
JoinRoomCC 
(CC  
IWebSocketConnectionCC 2
socketCC3 9
,CC9 :
stringCC; A
roomNameCCB J
)CCJ K
{DD 	
ifEE 
(EE 
!EE 
_roomConnectionsEE !
.EE! "
ContainsKeyEE" -
(EE- .
roomNameEE. 6
)EE6 7
)EE7 8
{FF 
_roomConnectionsGG  
[GG  !
roomNameGG! )
]GG) *
=GG+ ,
newGG- 0
ListGG1 5
<GG5 6 
IWebSocketConnectionGG6 J
>GGJ K
(GGK L
)GGL M
;GGM N
}HH 
ifJJ 
(JJ 
!JJ 
_roomConnectionsJJ !
[JJ! "
roomNameJJ" *
]JJ* +
.JJ+ ,
ContainsJJ, 4
(JJ4 5
socketJJ5 ;
)JJ; <
)JJ< =
{KK 
_roomConnectionsLL  
[LL  !
roomNameLL! )
]LL) *
.LL* +
AddLL+ .
(LL. /
socketLL/ 5
)LL5 6
;LL6 7
socketMM 
.MM 
SendMM 
(MM 
$"MM 
$strMM +
{MM+ ,
roomNameMM, 4
}MM4 5
"MM5 6
)MM6 7
;MM7 8
}NN 
}OO 	
privateQQ 
voidQQ 
	LeaveRoomQQ 
(QQ  
IWebSocketConnectionQQ 3
socketQQ4 :
,QQ: ;
stringQQ< B
roomNameQQC K
)QQK L
{RR 	
ifSS 
(SS 
_roomConnectionsSS  
.SS  !
ContainsKeySS! ,
(SS, -
roomNameSS- 5
)SS5 6
&&SS7 9
_roomConnectionsSS: J
[SSJ K
roomNameSSK S
]SSS T
.SST U
ContainsSSU ]
(SS] ^
socketSS^ d
)SSd e
)SSe f
{TT 
_roomConnectionsUU  
[UU  !
roomNameUU! )
]UU) *
.UU* +
RemoveUU+ 1
(UU1 2
socketUU2 8
)UU8 9
;UU9 :
socketVV 
.VV 
SendVV 
(VV 
$"VV 
$strVV )
{VV) *
roomNameVV* 2
}VV2 3
"VV3 4
)VV4 5
;VV5 6
}WW 
elseXX 
{YY 
socketZZ 
.ZZ 
SendZZ 
(ZZ 
$"ZZ 
$strZZ 7
{ZZ7 8
roomNameZZ8 @
}ZZ@ A
"ZZA B
)ZZB C
;ZZC D
}[[ 
}\\ 	
private^^ 
void^^ 
SendMessageToRoom^^ &
(^^& '
string^^' -
roomName^^. 6
,^^6 7
string^^8 >
message^^? F
,^^F G 
IWebSocketConnection^^H \
sender^^] c
)^^c d
{__ 	
if`` 
(`` 
_roomConnections``  
.``  !
ContainsKey``! ,
(``, -
roomName``- 5
)``5 6
&&``7 9
_roomConnections``: J
[``J K
roomName``K S
]``S T
.``T U
Contains``U ]
(``] ^
sender``^ d
)``d e
)``e f
{aa 
foreachbb 
(bb 
varbb 
socketbb #
inbb$ &
_roomConnectionsbb' 7
[bb7 8
roomNamebb8 @
]bb@ A
)bbA B
{cc 
ifdd 
(dd 
socketdd 
!=dd !
senderdd" (
)dd( )
{ee 
socketff 
.ff 
Sendff #
(ff# $
messageff$ +
)ff+ ,
;ff, -
}gg 
}hh 
}ii 
elsejj 
{kk 
senderll 
.ll 
Sendll 
(ll 
$"ll 
$strll 7
{ll7 8
roomNamell8 @
}ll@ A
"llA B
)llB C
;llC D
}mm 
}nn 	
privatepp 
voidpp 
RemoveConnectionpp %
(pp% & 
IWebSocketConnectionpp& :
socketpp; A
)ppA B
{qq 	
foreachrr 
(rr 
varrr 
roomrr 
inrr  
_roomConnectionsrr! 1
.rr1 2
Keysrr2 6
.rr6 7
ToListrr7 =
(rr= >
)rr> ?
)rr? @
{ss 
iftt 
(tt 
_roomConnectionstt $
[tt$ %
roomtt% )
]tt) *
.tt* +
Containstt+ 3
(tt3 4
sockettt4 :
)tt: ;
)tt; <
{uu 
_roomConnectionsvv $
[vv$ %
roomvv% )
]vv) *
.vv* +
Removevv+ 1
(vv1 2
socketvv2 8
)vv8 9
;vv9 :
ifww 
(ww 
!ww 
_roomConnectionsww )
[ww) *
roomww* .
]ww. /
.ww/ 0
Anyww0 3
(ww3 4
)ww4 5
)ww5 6
{xx 
_roomConnectionsyy (
.yy( )
Removeyy) /
(yy/ 0
roomyy0 4
)yy4 5
;yy5 6
}zz 
}{{ 
}|| 
}}} 	
public 
void 
	Broadcast 
( 
string $
roomName% -
,- .
string/ 5
message6 =
)= >
{
€€ 	
if
 
(
 
_roomConnections
  
.
  !
ContainsKey
! ,
(
, -
roomName
- 5
)
5 6
)
6 7
{
‚‚ 
foreach
ƒƒ 
(
ƒƒ 
var
ƒƒ 
socket
ƒƒ #
in
ƒƒ$ &
_roomConnections
ƒƒ' 7
[
ƒƒ7 8
roomName
ƒƒ8 @
]
ƒƒ@ A
)
ƒƒA B
{
„„ 
socket
…… 
.
…… 
Send
…… 
(
……  
message
……  '
)
……' (
;
……( )
}
†† 
}
‡‡ 
}
ˆˆ 	
}
‰‰ 
}ŠŠ 